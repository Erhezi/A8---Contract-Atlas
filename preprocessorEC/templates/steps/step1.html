<!-- Pre-Checking Content -->
<style>
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
        padding-right: 15px;
        padding-left: 15px;
        box-sizing: border-box;
    }

/* For mobile responsiveness */
@media (max-width: 991px) {
    .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
</style>


<div class="step-content">
    <h3>Step 1.1: Upload Contract Price File</h3>
    <p>Upload your contract price file to begin the pre-checking process. Accepted formats: .xlsx, .csv. Click to download the <a href="{{ url_for('main.download_template') }}" class="template-link">template</a> if needed.</p>
    <p style="font-size: 0.85rem; margin-top: -10px">We only support single file single sheet per run. If you have multiple contracts from the same manufacturer or manufacturer groups, merge them by stacking them into one file and upload.</p>
    
    <div id="upload-container">
        <form id="upload-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="file" style="margin-bottom: 5px; display: block">Select File</label>
                <input type="file" id="file" name="file" class="form-control-file" accept=".xlsx,.csv" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload File</button>
        </form>
    </div>
    
    <div id="mapping-container" style="display:none; margin-top: 20px;">
        <h3 style="font-size: 1.2rem;">Step 1.2: Map File Columns</h3>
        <p style="font-size: 0.9rem;">Please map your file columns to our required fields:</p>
        

        <form id="mapping-form">
            <div class="compact-form">
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Manufacturer Part Number*:</label>
                            <select name="Mfg Part Num" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Vendor Part Number*:</label>
                            <select name="Vendor Part Num" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Buyer Part Number (Optional):</label>
                            <select name="Buyer Part Num" class="form-control form-control-sm">
                                <option value="">Not Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Description*:</label>
                            <select name="Description" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Contract Price*:</label>
                            <select name="Contract Price" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Unit of Measure (UOM)*:</label>
                            <select name="UOM" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Quantity of Each (QOE)*:</label>
                            <select name="QOE" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Effective Date*:</label>
                            <select name="Effective Date" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Expiration Date*:</label>
                            <select name="Expiration Date" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Contract Number*:</label>
                            <select name="Contract Number" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">ERP Vendor ID*:</label>
                            <select name="ERP Vendor ID" class="form-control form-control-sm required-field"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Empty column for alignment purposes -->
                    </div>
                </div>
            </div>
            <p><small>* Required fields</small></p>
            <button type="submit" class="btn btn-primary mb-4">Validate</button>
            <div class="form-group mt-5" style="margin-top: 20px;">
                <label><strong>Duplicate Checking Mode:</strong></label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="duplicate_mode" id="defaultMode" value="default" 
                        {% if not session.get('duplicate_check_mode') or session.get('duplicate_check_mode') == 'default' %}checked{% endif %}>
                    <label class="form-check-label" for="defaultMode">
                        Default (Contract Number + Reduced Mfg Part Num)
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="duplicate_mode" id="explicitMode" value="explicit"
                        {% if session.get('duplicate_check_mode') == 'explicit' %}checked{% endif %}>
                    <label class="form-check-label" for="explicitMode">
                        Explicit (Contract Number + Mfg Part Num + UOM)
                    </label>
                </div>
                <small class="form-text text-muted">
                    Use explicit mode only after you have first reviewed all your potential duplicates and you are sure they should be identified by their explicit manufacturer part number and UOM.
                </small>
            </div>
        </form>
    </div>
    
    <div id="validation-container" style="display:none; margin-top: 20px;">
        <h3>Step 1.3: File Validation</h3>
        <div id="validation-results"></div>
        
        <div id="validation-stats" style="display:none; margin: 15px 0 20px 0;">
            <div class="validation-stats-container" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                <div class="stat-card" style="flex: 1; min-width: 150px; background-color: #f8f9fa; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 style="font-size: 1rem; margin: 0; color: #495057;">Total Rows</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #212529;" id="total-rows">0</p>
                </div>
                
                <div id="error-card" class="stat-card" style="flex: 1; min-width: 150px; background-color: #f8d7da; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 id="error-label" style="font-size: 1rem; margin: 0; color: #721c24;">Rows with Errors</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #721c24;" id="error-rows">0</p>
                </div>
                
                <div id="duplicate-card" class="stat-card" style="flex: 1; min-width: 150px; background-color: #fff3cd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 id="duplicate-label" style="font-size: 1rem; margin: 0; color: #856404;">Potential Duplicates</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #856404;" id="duplicate-rows">0</p>
                </div>
            </div>
        </div>

        <div id="error-display" style="display:none;">
            <h4>Validation Errors</h4>
            <div class="table-responsive-container">
                <div id="error-table-container"></div>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <a id="download-error-link" href="{{ url_for('main.download_error_file') }}" class="btn btn-warning">Download Error Report</a>
                <a href="{{ url_for('main.dashboard', restart=1) }}" class="btn btn-secondary">Start Over</a>
            </div>
        </div>
        
        <div id="success-display" style="display:none;">
            <div class="alert alert-success">
                <h4><i class="icon">âœ“</i> PASS!</h4>
                <p>All validation checks have passed successfully.</p>
            </div>
            <form method="POST" action="{{ url_for('main.process_step', step_id=1) }}">
                <button type="submit" class="btn btn-success">Complete Step 1</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // File Upload Form
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadBtn = this.querySelector('button[type="submit"]');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            fetch('/upload-file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                
                if (data.success) {
                    // Show mapping container
                    document.getElementById('upload-container').innerHTML = `
                        <div class="alert alert-success">
                            <strong>File uploaded:</strong> ${data.filename}
                        </div>
                    `;
                    
                    // Define column name variations for auto-mapping
                    const columnMappings = {
                        'Mfg Part Num': ['mfg part num', 'mfg part number', 'manufacturer part', 'manufacturer part number', 'mfr part', 'mfrpartnum', 'mfg part #', 'manufacturer part #', 'manufacturer number'],
                        'Vendor Part Num': ['vendor part', 'vendor part num', 'vendor part number', 'supplier part', 'supplierpartnum', 'vendor part #', 'supplier part #', 'vendor item'],
                        'Buyer Part Num': ['buyer part', 'buyer part num', 'buyer part number', 'customer part', 'customerpartnum', 'buyer part #', 'customer part #'],
                        'Description': ['description', 'desc', 'item desc', 'product desc', 'item description'],
                        'Contract Price': ['contract price', 'price', 'unit price', 'cost', 'contract cost'],
                        'UOM': ['uom', 'unit of measure', 'unit', 'measure', 'unit measure'],
                        'QOE': ['qoe', 'quantity of each', 'qty each', 'package qty', 'qty per package'],
                        'Effective Date': ['effective date', 'start date', 'valid from', 'start', 'begin date'],
                        'Expiration Date': ['expiration date', 'exp date', 'end date', 'valid until', 'termination date'],
                        'Contract Number': ['contract number', 'contract num', 'contract #', 'contract id', 'agreement number'],
                        'ERP Vendor ID': ['erp vendor id', 'vendor id', 'supplier id', 'erp supplier', 'vendor code']
                    };
                    
                    // Normalize headers to lowercase for matching
                    const normalizedHeaders = data.headers.map(h => h.toLowerCase());
                    
                    // Auto-map columns based on similar names
                    const autoMappings = {};
                    let unmatchedFields = 0;
                    
                    // Populate dropdowns with file headers
                    const selects = document.querySelectorAll('#mapping-form select');
                    selects.forEach(select => {
                        // Clear any existing options
                        select.innerHTML = '';
                        
                        // Add empty option
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = '-- Select Column --';
                        select.appendChild(emptyOption);
                        
                        // Add headers as options
                        data.headers.forEach(header => {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            select.appendChild(option);
                        });
                        
                        // Try to auto-match this field
                        const fieldName = select.name;
                        if (columnMappings[fieldName]) {
                            // Look for a match in the uploaded headers
                            let bestMatch = null;
                            
                            // First try exact match
                            const exactMatch = normalizedHeaders.findIndex(h => 
                                columnMappings[fieldName].includes(h));
                            
                            if (exactMatch !== -1) {
                                bestMatch = data.headers[exactMatch];
                            } else {
                                // Try partial match
                                for (let i = 0; i < normalizedHeaders.length; i++) {
                                    for (let j = 0; j < columnMappings[fieldName].length; j++) {
                                        if (normalizedHeaders[i].includes(columnMappings[fieldName][j]) || 
                                            columnMappings[fieldName][j].includes(normalizedHeaders[i])) {
                                            bestMatch = data.headers[i];
                                            break;
                                        }
                                    }
                                    if (bestMatch) break;
                                }
                            }
                            
                            if (bestMatch) {
                                select.value = bestMatch;
                                autoMappings[fieldName] = bestMatch;
                                
                                // Add visual indicator for auto-matched fields
                                const parentDiv = select.closest('.form-group');
                                parentDiv.classList.add('auto-matched');
                                const label = parentDiv.querySelector('label');
                                label.innerHTML += ' <span class="auto-match-indicator">(Auto-matched)</span>';
                            } else if (select.classList.contains('required-field')) {
                                unmatchedFields++;
                            }
                        }
                    });
                    
                    // Show mapping container with a message about auto-matching
                    document.getElementById('mapping-container').style.display = 'block';
                    
                    // Add notification about auto-matching
                    const mappingForm = document.getElementById('mapping-form');
                    const autoMapNotice = document.createElement('div');
                    autoMapNotice.className = 'alert alert-info';
                    
                    if (Object.keys(autoMappings).length > 0) {
                        autoMapNotice.innerHTML = `
                            <strong>Auto-matched ${Object.keys(autoMappings).length} columns.</strong> 
                            ${unmatchedFields > 0 ? 'Please review and complete the ' + unmatchedFields + ' remaining required fields.' : 'All required fields were matched! Please review and confirm.'}
                        `;
                        mappingForm.insertBefore(autoMapNotice, mappingForm.firstChild);
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                alert('Error uploading file: ' + error);
            });
        });

   
        
        // Column Mapping Form
        document.getElementById('mapping-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate that all required fields are mapped
            const requiredSelects = document.querySelectorAll('.required-field');
            let isValid = true;
            
            requiredSelects.forEach(select => {
                if (!select.value) {
                    isValid = false;
                    select.classList.add('is-invalid');
                } else {
                    select.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Please map all required fields');
                return;
            }
            
            const formData = new FormData(this);
            const mappingBtn = this.querySelector('button[type="submit"]');
            mappingBtn.disabled = true;
            mappingBtn.textContent = 'Processing...';
            
            // First save the column mapping
            fetch('/map-columns', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Now validate the file
                    return fetch('/validate-file', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                mappingBtn.disabled = false;
                mappingBtn.textContent = 'Validate';
                
                document.getElementById('validation-container').style.display = 'block';

                // Update stats regardless of success/failure
                if (data.stats) {
                    document.getElementById('validation-stats').style.display = 'block';
                    
                    // Update total rows
                    document.getElementById('total-rows').textContent = data.stats.total_rows || 0;
                    
                    // Update error rows and change color based on value
                    const errorRows = data.stats.error_rows || 0;
                    document.getElementById('error-rows').textContent = errorRows;
                    
                    // Error card - change to green if no errors
                    const errorCard = document.getElementById('error-card');
                    const errorLabel = document.getElementById('error-label');
                    const errorCount = document.getElementById('error-rows');
                    
                    if (errorRows === 0) {
                        // Change to success green
                        errorCard.style.backgroundColor = '#d4edda';
                        errorLabel.style.color = '#155724';
                        errorCount.style.color = '#155724';
                    } else {
                        // Keep as error red
                        errorCard.style.backgroundColor = '#f8d7da';
                        errorLabel.style.color = '#721c24';
                        errorCount.style.color = '#721c24';
                    }
                    
                    // Update duplicate rows and change color based on value
                    const duplicateRows = data.stats.duplicate_rows || 0;
                    document.getElementById('duplicate-rows').textContent = duplicateRows;
                    
                    // Duplicate card - change to green if no duplicates
                    const duplicateCard = document.getElementById('duplicate-card');
                    const duplicateLabel = document.getElementById('duplicate-label');
                    const duplicateCount = document.getElementById('duplicate-rows');
                    
                    if (duplicateRows === 0) {
                        // Change to success green
                        duplicateCard.style.backgroundColor = '#d4edda';
                        duplicateLabel.style.color = '#155724';
                        duplicateCount.style.color = '#155724';
                    } else {
                        // Keep as warning yellow
                        duplicateCard.style.backgroundColor = '#fff3cd';
                        duplicateLabel.style.color = '#856404';
                        duplicateCount.style.color = '#856404';
                    }
                }
                
                if (data.success) {
                    // Show success message
                    document.getElementById('validation-results').innerHTML = `
                        <div class="alert alert-success">${data.message}</div>
                    `;
                    document.getElementById('error-display').style.display = 'none';
                    document.getElementById('success-display').style.display = 'block';
                } else {
                    // Show error message and table
                    document.getElementById('validation-results').innerHTML = `
                        <div class="alert alert-danger">${data.message}</div>
                    `;
                    document.getElementById('error-table-container').innerHTML = data.error_table;
                    const table = document.querySelector('#error-table-container table');
                    if (table) {
                        table.style.width = 'max-content';
                        table.style.minwidth = '100%';
                    }
                    document.getElementById('error-display').style.display = 'block';
                    document.getElementById('success-display').style.display = 'none';
                    
                    // Add styles to highlight error rows
                    const errorTable = document.querySelector('#error-table-container table');
                    if (errorTable) {
                        const rows = errorTable.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            row.style.backgroundColor = '#fee';
                        });
                    }
                }
            })
            .catch(error => {
                mappingBtn.disabled = false;
                mappingBtn.textContent = 'Validate';
                alert('Error: ' + error.message);
            });
        });
    });
</script>
