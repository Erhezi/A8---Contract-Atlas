<!-- Pre-Checking Content -->
<style>
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
        padding-right: 15px;
        padding-left: 15px;
        box-sizing: border-box;
    }

/* For mobile responsiveness */
@media (max-width: 991px) {
    .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

/* Style for input-group elements */
.input-group {
    display: flex;
    width: 100%;
}

.input-group-prepend {
    display: flex;
}

.input-group-text {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 0.25rem 0 0 0.25rem;
}

.input-group select.form-control {
    flex: 1 1 auto;
    width: 1%;
    min-width: 0;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

/* Bootstrap Input Group Styles */
.input-group {
  position: relative;
  display: flex;
  flex-wrap: wrap;
  align-items: stretch;
  width: 100%;
}

.custom-file {
  position: relative;
  display: flex;
  flex: 1 1 auto;
  width: 1%;
  min-width: 0;
  margin-bottom: 0;
}

.custom-file-input {
  position: relative;
  z-index: 2;
  width: 100%;
  height: calc(1.5em + 0.75rem + 2px);
  margin: 0;
  opacity: 0;
}

.custom-file-label {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  z-index: 1;
  display: flex;
  align-items: center;
  height: calc(1.5em + 0.75rem + 2px);
  padding: 0.375rem 0.75rem;
  font-weight: 400;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.input-group-append {
  display: flex;
  margin-left: -1px;
}

.input-group > .input-group-append > .btn {
  display: flex;
  align-items: center;
  padding: 0.375rem 0.75rem;
  margin-bottom: 0;
  font-size: 1rem;
  font-weight: 400;
  line-height: 1.5;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}

/* Fix for height inconsistency */
.custom-file,
.custom-file-input,
.custom-file-label,
.input-group-append > .btn {
  height: calc(1.5em + 0.75rem + 2px);
}

/* Additional fixes for alignment */
.input-group {
    align-items: stretch;
}

.custom-file-label {
    display: flex;
    align-items: center;
    line-height: 1.2;
    padding-top: 0.375rem;
    padding-bottom: 0.375rem;
}

/* Ensure the label text is vertically centered with buttons */
.custom-file-label::after {
    height: 100%;
    display: flex;
    align-items: center;
}

.input-group-append .btn {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Ensure consistent heights */
.input-group > .form-control,
.input-group > .custom-file,
.input-group > .custom-file .custom-file-input,
.input-group > .custom-file .custom-file-label,
.input-group > .input-group-append > .btn {
    height: calc(1.5em + 0.75rem + 2px);
    line-height: 1.5;
}

/* More targeted fixes for height inconsistency */
#upload-form .input-group {
    align-items: center;
}

#upload-form .custom-file {
    height: 36px; /* Reduced from 38px */
}

#upload-form .custom-file-input {
    height: 36px; /* Reduced from 38px */
}

#upload-form .custom-file-label {
    height: 36px; /* Reduced from 38px */
    padding: 0.3rem 0.75rem; /* Slightly reduced padding */
    padding-right: 2.5rem; /* Add extra padding on the right side */
    margin-right: 1px; /* Add a small margin to prevent overlap */
    display: flex;
    align-items: center;
    line-height: 1.5;
    margin-bottom: 0;
}

#upload-form .input-group-append .btn {
    height: 36px; /* Reduced from 38px */
    padding: 0.3rem 0.75rem; /* Slightly reduced padding */
    margin-top: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.5;
}

/* Override the global btn styles */
#upload-form .btn {
    margin-top: 0;
    padding: 0.3rem 0.75rem; /* Slightly reduced padding */
    box-sizing: border-box;
}

/* Remove any unwanted margins */
#upload-form .input-group > * {
    margin-bottom: 0;
    vertical-align: middle;
}

/* Ensure consistent border styling */
#upload-form .input-group * {
    box-sizing: border-box;
}

/* Style updates for buttons */
#upload-form .btn-outline-secondary {
    color: #6c757d;
    border-color: #6c757d;
    background-color: transparent;
    transition: all 0.3s ease;
}

/* Specific style for the Browse button */
#upload-form #file-browsing-btn {
    border: 1px solid #ced4da;  /* Changed to lighter grey */
    color: #495057;  /* Changed to darker grey */
    background-color: #f8f9fa;  /* Light grey background */
}

/* Remove hover effect for Browse button */
#upload-form #file-browsing-btn:hover {
    color: #495057;
    background-color: #f8f9fa;
    border-color: #ced4da;
}

#upload-form #file-upload-btn {
    color: #fff;
    background-color: #6c757d;  /* Changed to grey */
    border-color: #6c757d;      /* Changed to grey */
    transition: all 0.3s ease;
}

/* Remove hover effect for Upload button */
#upload-form #file-upload-btn:hover {
    background-color: #6c757d;
    border-color: #6c757d;
}

/* Blue button style for when file is selected */
#upload-form #file-upload-btn.file-selected {
    background-color: #3498db;
    border-color: #3498db;
}
</style>


<div class="step-content">
    <h3>Step 1.1: Upload Contract Price File</h3>
    <p>Upload your contract price file to begin the pre-checking process. Accepted formats: .xlsx, .csv. Click to download the <a href="{{ url_for('common.download_template') }}" class="template-link">template</a> if needed.</p>
    <p style="font-size: 0.85rem; margin-top: -5px">We only support single file single sheet per run. If you have multiple contracts from the same manufacturer or manufacturer groups, merge them by stacking them into one file and upload.</p>
    
    <div id="upload-container">
        <form id="upload-form" enctype="multipart/form-data">
            <div class="input-group">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="file" name="file" accept=".xlsx,.csv" placeholder="Choose File" >
                    <label class="custom-file-label" for="file">Choose file</label>
                </div>
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="file-browsing-btn">Browse</button>
                    <button class="btn btn-outline-secondary" type="submit" id="file-upload-btn">Upload File</button>
                </div>
            </div>
        </form>
    </div>

    
    <div id="mapping-container" style="display:none; margin-top: 20px;">
        <h3 style="font-size: 1.2rem;">Step 1.2: Map File Columns</h3>
        <p style="font-size: 0.9rem;">Please map your file columns to our required fields:</p>
        

        <form id="mapping-form">
            <div class="compact-form">
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Manufacturer Part Number*:</label>
                            <select name="Mfg Part Num" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Vendor Part Number*:</label>
                            <select name="Vendor Part Num" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Buyer Part Number (Optional):</label>
                            <select name="Buyer Part Num" class="form-control form-control-sm column-mapping-select">
                                <option value="">Not Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Description*:</label>
                            <select name="Description" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Contract Price*:</label>
                            <select name="Contract Price" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Unit of Measure (UOM)*:</label>
                            <select name="UOM" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Quantity of Each (QOE)*:</label>
                            <select name="QOE" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Effective Date*:</label>
                            <select name="Effective Date" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Expiration Date*:</label>
                            <select name="Expiration Date" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Contract Number*:</label>
                            <select name="Contract Number" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">ERP Vendor ID*:</label>
                            <select name="ERP Vendor ID" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group compact-group">
                            <label class="compact-label">Source Contract Type*:</label>
                            <select name="Source Contract Type" class="form-control form-control-sm required-field column-mapping-select"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row form-row">
                    <div class="col-md-6">
                        <!-- Empty column for alignment purposes -->
                    </div>
                </div>
            </div>
            <p><small>* Required fields</small></p>
            <button type="submit" class="btn btn-primary mb-4">Validate</button>
            <div class="form-group mt-5" style="margin-top: 20px;">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Duplicate Checking Mode</span>
                    </div>
                    <select class="form-control" name="duplicate_mode" id="duplicate_mode">
                        <option value="default" selected>Default (Reduced Mfg Part Num)</option>
                        <option value="explicit">Explicit (Mfg Part Num + UOM)</option>
                        <option value="distributor">Distributor (ERP Vendor ID + Mfg Part Num + UOM)</option>
                    </select>
                </div>
                <div class="form-text text-muted mb-3" style="margin-top: 0.7rem !important;">
                    <small>Before checking, everything is converted into upper case with leading/trailing white-space(s) trimmed. Use explicit mode only after you have first reviewed all your potential duplicates and you are sure they should be identified by their explicit manufacturer part number and UOM. The distributor mode is intended for running pre-checker on Medline local contract(s).</small>
                </div>
            </div>
        </form>
    </div>
    
    <div id="validation-container" style="display:none; margin-top: 20px;">
        <h3>Step 1.3: File Validation</h3>
        <div id="validation-results"></div>
        
        <div id="validation-stats" style="display:none; margin: 15px 0 20px 0;">
            <div class="validation-stats-container" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                <div class="stat-card" style="flex: 1; min-width: 150px; background-color: #f8f9fa; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 style="font-size: 1rem; margin: 0; color: #495057;">Total Rows</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #212529;" id="total-rows">0</p>
                </div>
                
                <div id="error-card" class="stat-card" style="flex: 1; min-width: 150px; background-color: #f8d7da; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 id="error-label" style="font-size: 1rem; margin: 0; color: #721c24;">Rows with Errors</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #721c24;" id="error-rows">0</p>
                </div>
                
                <div id="duplicate-card" class="stat-card" style="flex: 1; min-width: 150px; background-color: #fff3cd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h5 id="duplicate-label" style="font-size: 1rem; margin: 0; color: #856404;">Potential Duplicates</h5>
                    <p style="font-size: 1.8rem; font-weight: bold; margin: 10px 0 0 0; color: #856404;" id="duplicate-rows">0</p>
                </div>
            </div>
        </div>

        <div id="error-display" style="display:none;">
            <h4>Validation Errors</h4>
            <div class="table-responsive-container">
                <div id="error-table-container"></div>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <a id="download-error-link" href="{{ url_for('file_processing.download_error_file') }}" class="btn btn-warning">Download Error Report</a>
                <a href="{{ url_for('common.dashboard', restart=1) }}" class="btn btn-secondary">Start Over</a>
            </div>
        </div>
        
        <div id="success-display" style="display:none;">
            <div class="alert alert-success">
                <h4><i class="icon">✓</i> PASS!</h4>
                <p>All validation checks have passed successfully.</p>
            </div>
            <form method="POST" action="{{ url_for('common.process_step', step_id=1) }}">
                <button type="submit" class="btn btn-success">Complete Step 1</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update file input label with selected filename
        document.getElementById('file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose file';
            const fileLabel = document.querySelector('.custom-file-label');
            fileLabel.textContent = fileName;
            
            // Change upload button color when file is selected
            const uploadBtn = document.getElementById('file-upload-btn');
            if (e.target.files[0]) {
                uploadBtn.classList.add('file-selected');
            } else {
                uploadBtn.classList.remove('file-selected');
            }
        });
        
        // Make the Browse button functional
        document.getElementById('file-browsing-btn').addEventListener('click', function() {
            document.getElementById('file').click();
        });
    
        // File Upload Form
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadBtn = this.querySelector('button[type="submit"]');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            fetch('/file-processing/upload-file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                
                if (data.success) {
                    // Show mapping container
                    document.getElementById('upload-container').innerHTML = `
                        <div class="alert alert-success">
                            <strong>File uploaded:</strong> ${data.filename}
                        </div>
                    `;
                    
                    // Define column name variations for auto-mapping
                    const columnMappings = {
                        'Mfg Part Num': ['mfg part num', 'mfg part number', 'manufacturer part', 'manufacturer part number', 'mfr part', 'mfrpartnum', 'mfg part #', 'manufacturer part #', 'manufacturer number'],
                        'Vendor Part Num': ['vendor part', 'vendor part num', 'vendor part number', 'supplier part', 'supplierpartnum', 'vendor part #', 'supplier part #', 'vendor item'],
                        'Buyer Part Num': ['buyer part', 'buyer part num', 'buyer part number', 'customer part', 'customerpartnum', 'buyer part #', 'customer part #'],
                        'Description': ['description', 'desc', 'item desc', 'product desc', 'item description'],
                        'Contract Price': ['contract price', 'price', 'unit price', 'cost', 'contract cost'],
                        'UOM': ['uom', 'unit of measure', 'unit', 'measure', 'unit measure'],
                        'QOE': ['qoe', 'quantity of each', 'qty each', 'package qty', 'qty per package'],
                        'Effective Date': ['effective date', 'start date', 'valid from', 'start', 'begin date'],
                        'Expiration Date': ['expiration date', 'exp date', 'end date', 'valid until', 'termination date'],
                        'Contract Number': ['contract number', 'contract num', 'contract #', 'contract id', 'agreement number'],
                        'ERP Vendor ID': ['erp vendor id', 'vendor id', 'supplier id', 'erp supplier', 'vendor code'],
                        'Source Contract Type': ['contract source type', 'source contract type', 'contract source', 'source type', 'contract type', 'agreement type', 'agreement source', 'gpo type', 'source', 'gpo or local']
                    };
                    
                    // Normalize headers to lowercase for matching
                    const normalizedHeaders = data.headers.map(h => h.toLowerCase());
                    
                    // Auto-map columns based on similar names
                    const autoMappings = {};
                    let unmatchedFields = 0;
                    
                    // Populate dropdowns with file headers
                    const selects = document.querySelectorAll('#mapping-form .column-mapping-select');
                    selects.forEach(select => {
                        // Clear any existing options
                        select.innerHTML = '';
                        
                        // Add empty option
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = '-- Select Column --';
                        select.appendChild(emptyOption);
                        
                        // Add headers as options
                        data.headers.forEach(header => {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            select.appendChild(option);
                        });
                        
                        // Try to auto-match this field
                        const fieldName = select.name;
                        if (columnMappings[fieldName]) {
                            // Look for a match in the uploaded headers
                            let bestMatch = null;
                            
                            // First try exact match
                            const exactMatch = normalizedHeaders.findIndex(h => 
                                columnMappings[fieldName].includes(h));
                            
                            if (exactMatch !== -1) {
                                bestMatch = data.headers[exactMatch];
                            } else {
                                // Try partial match
                                for (let i = 0; i < normalizedHeaders.length; i++) {
                                    for (let j = 0; j < columnMappings[fieldName].length; j++) {
                                        if (normalizedHeaders[i].includes(columnMappings[fieldName][j]) || 
                                            columnMappings[fieldName][j].includes(normalizedHeaders[i])) {
                                            bestMatch = data.headers[i];
                                            break;
                                        }
                                    }
                                    if (bestMatch) break;
                                }
                            }
                            
                            if (bestMatch) {
                                select.value = bestMatch;
                                autoMappings[fieldName] = bestMatch;
                                
                                // Add visual indicator for auto-matched fields
                                const parentDiv = select.closest('.form-group');
                                parentDiv.classList.add('auto-matched');
                                const label = parentDiv.querySelector('label');
                                label.innerHTML += ' <span class="auto-match-indicator">(Auto-matched)</span>';
                            } else if (select.classList.contains('required-field')) {
                                unmatchedFields++;
                            }
                        }
                    });
                    
                    // Show mapping container with a message about auto-matching
                    document.getElementById('mapping-container').style.display = 'block';
                    
                    // Add notification about auto-matching
                    const mappingForm = document.getElementById('mapping-form');
                    const autoMapNotice = document.createElement('div');
                    autoMapNotice.className = 'alert alert-info';
                    
                    if (Object.keys(autoMappings).length > 0) {
                        autoMapNotice.innerHTML = `
                            <strong>Auto-matched ${Object.keys(autoMappings).length} columns.</strong> 
                            ${unmatchedFields > 0 ? 'Please review and complete the ' + unmatchedFields + ' remaining required fields.' : 'All required fields were matched! Please review and confirm.'}
                        `;
                        mappingForm.insertBefore(autoMapNotice, mappingForm.firstChild);
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                alert('Error uploading file: ' + error);
            });
        });

   
        
        // Column Mapping Form
        document.getElementById('mapping-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate that all required fields are mapped
            const requiredSelects = document.querySelectorAll('.required-field');
            let isValid = true;
            
            requiredSelects.forEach(select => {
                if (!select.value) {
                    isValid = false;
                    select.classList.add('is-invalid');
                } else {
                    select.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Please map all required fields');
                return;
            }
            
            const formData = new FormData(this);
            const mappingBtn = this.querySelector('button[type="submit"]');
            mappingBtn.disabled = true;
            mappingBtn.textContent = 'Processing...';
            
            // First save the column mapping
            fetch('/file-processing/map-columns', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Now validate the file
                    return fetch('/file-processing/validate-file', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                mappingBtn.disabled = false;
                mappingBtn.textContent = 'Validate';
                
                document.getElementById('validation-container').style.display = 'block';

                // Update stats regardless of success/failure
                if (data.stats) {
                    document.getElementById('validation-stats').style.display = 'block';
                    
                    // Update total rows
                    document.getElementById('total-rows').textContent = data.stats.total_rows || 0;
                    
                    // Update error rows and change color based on value
                    const errorRows = data.stats.error_rows || 0;
                    document.getElementById('error-rows').textContent = errorRows;
                    
                    // Error card - change to green if no errors
                    const errorCard = document.getElementById('error-card');
                    const errorLabel = document.getElementById('error-label');
                    const errorCount = document.getElementById('error-rows');
                    
                    if (errorRows === 0) {
                        // Change to success green
                        errorCard.style.backgroundColor = '#d4edda';
                        errorLabel.style.color = '#155724';
                        errorCount.style.color = '#155724';
                    } else {
                        // Keep as error red
                        errorCard.style.backgroundColor = '#f8d7da';
                        errorLabel.style.color = '#721c24';
                        errorCount.style.color = '#721c24';
                    }
                    
                    // Update duplicate rows and change color based on value
                    const duplicateRows = data.stats.duplicate_rows || 0;
                    document.getElementById('duplicate-rows').textContent = duplicateRows;
                    
                    // Duplicate card - change to green if no duplicates
                    const duplicateCard = document.getElementById('duplicate-card');
                    const duplicateLabel = document.getElementById('duplicate-label');
                    const duplicateCount = document.getElementById('duplicate-rows');
                    
                    if (duplicateRows === 0) {
                        // Change to success green
                        duplicateCard.style.backgroundColor = '#d4edda';
                        duplicateLabel.style.color = '#155724';
                        duplicateCount.style.color = '#155724';
                    } else {
                        // Keep as warning yellow
                        duplicateCard.style.backgroundColor = '#fff3cd';
                        duplicateLabel.style.color = '#856404';
                        duplicateCount.style.color = '#856404';
                    }
                }
                
                if (data.success) {
                    // Show success message
                    document.getElementById('validation-results').innerHTML = `
                        <div class="alert alert-success">${data.message}</div>
                    `;
                    document.getElementById('error-display').style.display = 'none';
                    document.getElementById('success-display').style.display = 'block';
                } else {
                    // Show error message and table
                    document.getElementById('validation-results').innerHTML = `
                        <div class="alert alert-danger">${data.message}</div>
                    `;
                    document.getElementById('error-table-container').innerHTML = data.error_table;
                    const table = document.querySelector('#error-table-container table');
                    if (table) {
                        table.style.width = 'max-content';
                        table.style.minwidth = '100%';
                    }
                    document.getElementById('error-display').style.display = 'block';
                    document.getElementById('success-display').style.display = 'none';
                    
                    // Add styles to highlight error rows
                    const errorTable = document.querySelector('#error-table-container table');
                    if (errorTable) {
                        const rows = errorTable.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            row.style.backgroundColor = '#fee';
                        });
                    }
                }
            })
            .catch(error => {
                mappingBtn.disabled = false;
                mappingBtn.textContent = 'Validate';
                alert('Error: ' + error.message);
            });
        });
    });
</script>
