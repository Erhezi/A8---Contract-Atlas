<!-- Step 4: Matching to Infor -->
<style>
    /* Styles adapted from step2.html for item-level comparison */
    .step-content {
        margin-bottom: 20px;
    }
    .items-table-container {
        margin-top: 20px;
        overflow-x: auto;
        overflow-y: auto; /* Add vertical scrolling */
        max-width: 100%;
        max-height: 700px; /* Limit table height */
        border: 1px solid #eee;
        display: none; /* Hidden initially */
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem; 
    }

    .items-table th, 
    .items-table td {
        padding: 6px; 
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap; /* Prevent wrapping initially */
    }

    /* Allow description columns to wrap */
    .items-table th.description-col,
    .items-table td.description-col {
        white-space: normal;
        min-width: 150px; /* Ensure a minimum width */
        max-width: 300px; /* Limit max width */
    }
    
    .items-table th {
        background-color: #f5f5f5;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
    }
    
    .items-table th:hover {
        background-color: #e9e9e9;
    }
    
    .items-table tbody tr:hover {
        background-color: #f0f7ff;
    }
    
    .items-table .sort-indicator {
        margin-left: 5px;
        opacity: 0.5;
    }
    
    .items-table th.sort-asc .sort-indicator::after {
        content: "▲";
    }
    
    .items-table th.sort-desc .sort-indicator::after {
        content: "▼";
    }

    .match-indicator {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .match-indicator.match::before {
        content: "✓";
        color: #2ecc71;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .match-indicator.no-match::before {
        content: "✗";
        color: #e74c3c;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .no-matches {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin: 20px 0;
        display: none; /* Hidden initially */
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
        display: none; /* Hidden initially */
    }

    .search-wrapper {
        display: flex;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        height: 38px;
    }
    
    .search-input {
        padding: 8px 12px;
        border: none;
        width: 300px;
    }

    .clear-search-btn {
        background: #f5f5f5;
        border: none;
        border-left: 1px solid #ddd;
        padding: 0 12px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        min-width: 60px;
    }
    
    .clear-search-btn:hover {
        background: #e0e0e0;
        color: #333;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        display: none; /* Hidden initially */
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .result-summary {
        background-color: #eef2f7;
        border: 1px solid #d6e0ea;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 15px;
        display: none; /* Hidden initially */
    }

    .action-buttons {
        margin-top: 20px;
        text-align: right;
        display: none; /* Hidden initially */
    }

    /* Placeholder for subsequent steps */
    .substep-placeholder {
        padding: 20px;
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 5px;
        margin-top: 30px;
        text-align: center;
        color: #6c757d;
    }

    /* Confidence Cards Styles - from step2.html */
    .confidence-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .confidence-card {
        flex: 1;
        min-width: 240px;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .confidence-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .confidence-card.selected {
        border: 2px solid #3498db;
    }
    
    .confidence-card.high {
        border-top: 5px solid #2ecc71;
    }
    
    .confidence-card.medium {
        border-top: 5px solid #f39c12;
    }
    
    .confidence-card.low {
        border-top: 5px solid #e74c3c;
    }
    
    .confidence-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .confidence-card.high .confidence-title {
        color: #2ecc71;
    }
    
    .confidence-card.medium .confidence-title {
        color: #f39c12;
    }
    
    .confidence-card.low .confidence-title {
        color: #e74c3c;
    }
    
    .count-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .count-label {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .false-positive-count {
        color: #e74c3c;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    /* Batch controls */
    .controls-container {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .filter-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .batch-controls {
        display: flex;
        gap: 10px;
    }
    
    .score-cell {
        text-align: center;
        font-weight: bold;
    }
    
    .high-score {
        color: #2ecc71;
    }
    
    .medium-score {
        color: #f39c12;
    }
    
    .low-score {
        color: #e74c3c;
    }
    
    .search-type-select {
        padding: 8px;
        border: none;
        border-right: 1px solid #ddd;
        background-color: #f5f5f5;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    /* Item comparison container */
    .item-comparison-container {
        margin-top: 20px;
        display: none; /* Hidden initially, shown after processing */
    }

    /* Enhanced Summary Cards Styling - Matching Step 3 */
    .summary-stats-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Changed to 3 columns to fit all cards in one row */
        gap: 20px; /* Increase gap between cards */
        width: 100%;
        margin-right: 0;
        margin-left: 0;
        margin-top: 0;
        margin-bottom: 10px;
    }

    .summary-stats-column {
        padding: 0;
    }

    .summary-stat-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-left: 5px solid #3498db;
        height: 100%;
    }

    .summary-stat-card .card-body {
        padding: 10px 15px 10px;
    }

    .summary-stat-card .card-title {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 8px;
        margin-top: 2px;
        font-weight: normal;
    }

    .summary-stat-card .stat-value {
        font-size: 1.7rem;
        font-weight: bold;
        color: #2c3e50;
        margin-top: 0px;
    }

    .need-review-card {
        border-left-color: #9b59b6; /* Purple */
    }

    .no-review-card {
        border-left-color: #2ecc71; /* Green */
    }

    .item-master-card {
        border-left-color: #3498db; /* Blue */
    }


    .items-table th {
        background-color: #f5f5f5;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
        padding: 6px;
        text-align: left;
        white-space: normal; /* Allow text wrapping */
        height: auto;
        vertical-align: middle;
    }

    .items-table .sort-indicator {
        margin-left: 5px;
        opacity: 0.5;
    }


    .items-table th.description-col {
        min-width: 150px;
    }

    #items-table-4-2 td:nth-child(4) {
        text-align: center !important;
        vertical-align: middle !important;
    }

    #items-table-4-2 td:nth-child(4) .match-indicator {
        display: flex !important;
        justify-content: center !important;
        width: 70% !important;
    }

    #items-table-4-1 th:nth-child(2),
    #items-table-4-1 td:nth-child(2),
    #items-table-4-1 th:nth-child(3),
    #items-table-4-1 td:nth-child(3){
        width: 5%;  
        min-width: 80px; 
        overflow: hidden;
        text-overflow: ellipsis;
    }

</style>

<div class="step-content">
    <!-- Step 4.1: Match to Infor Contract Lines -->
    <div id="step-4-1-content">
        <h3>Step 4.1: Match to Infor Contract Lines</h3>
        <p>Match uploaded items against the Infor Contract Lines database to identify potential existing items.</p>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
            <button id="start-infor-cl-matching-btn" class="btn btn-primary">
                Start Matching
            </button>
        </div>
        
        <!-- Review Summary Card - Styled to match step3.html -->
        <div id="review-summary-card-4-1" class="result-summary" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 15px;">Upload - Infor Contract Matching Review Status Summary</h4>
            <div class="summary-stats-row">
                <div class="summary-stats-column">
                    <div class="summary-stat-card need-review-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Review Needed</h5>
                            <div class="stat-value" id="need-review-count-4-1">0</div>
                            <div class="text-muted">Items requiring manual review</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card no-review-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">No Review Needed</h5>
                            <div class="stat-value" id="no-need-review-count-4-1">0</div>
                            <div class="text-muted">Items automatically matched</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card item-master-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Item Master Item</h5>
                            <div class="stat-value" id="item-master-count-4-1">0</div>
                            <div class="text-muted">Items with Infor Item Number</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Item Comparison Container - Similar to step2.html -->
        <div id="item-comparison-container-4-1" class="item-comparison-container">
            <div id="comparison-results-container-4-1">
                <div class="confidence-cards">
                    <div id="high-confidence-card-4-1" class="confidence-card high" data-level="high">
                        <div class="confidence-title">High Confidence</div>
                        <div class="count-number" id="high-count-4-1">0</div>
                        <div class="count-label">Items</div>
                        <div class="false-positive-count" id="high-false-positive-count-4-1">0 marked as false positive</div>
                    </div>
                    
                    <div id="medium-confidence-card-4-1" class="confidence-card medium" data-level="medium">
                        <div class="confidence-title">Medium Confidence</div>
                        <div class="count-number" id="medium-count-4-1">0</div>
                        <div class="count-label">Items</div>
                        <div class="false-positive-count" id="medium-false-positive-count-4-1">0 marked as false positive</div>
                    </div>
                    
                    <div id="low-confidence-card-4-1" class="confidence-card low" data-level="low">
                        <div class="confidence-title">Low Confidence</div>
                        <div class="count-number" id="low-count-4-1">0</div>
                        <div class="count-label">Items</div>
                        <div class="false-positive-count" id="low-false-positive-count-4-1">0 marked as false positive</div>
                    </div>
                </div>
                
                <div id="items-detail-view-4-1" style="display:none;">
                    <h4 id="detail-title-4-1">High Confidence Matches</h4>
                    
                    <div class="controls-container">
                        <div class="filter-container">
                            <div class="search-wrapper">
                                <select id="item-search-type-4-1" class="search-type-select">
                                    <option value="contains">Contains</option>
                                    <option value="not-contains">Not Contains</option>
                                </select>
                                <input type="text" id="item-search-4-1" class="search-input" placeholder="Filter items...">
                                <button type="button" id="clear-search-btn-4-1" class="clear-search-btn" title="Clear search">Clear</button>
                            </div>
                        </div>
                        
                        <div class="batch-controls">
                            <button id="select-all-btn-4-1" class="btn btn-sm btn-secondary">Select All</button>
                            <button id="deselect-all-btn-4-1" class="btn btn-sm btn-secondary">Deselect All</button>
                            <button id="save-selections-btn-4-1" class="btn btn-sm btn-primary">Save Selections</button>
                        </div>
                    </div>
                    
                    <div class="items-table-container">
                        <table id="items-table-4-1" class="items-table">
                            <thead>
                                <tr>
                                    <th data-sort="item_number_infor">Infor Item #<span class="sort-indicator"></span></th>
                                    <th data-sort="mfg_part_num_infor">Mfg Part Num (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="Mfg_Part_Num">Mfg Part Num (Upload)<span class="sort-indicator"></span></th>
                                    <th data-sort="uom_infor">UOM (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="UOM">UOM (Upload)<span class="sort-indicator"></span></th>
                                    <th data-sort="qoe_infor">QOE (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="QOE">QOE (Upload)<span class="sort-indicator"></span></th>
                                    <th data-sort="infor_ea_price">EA Price (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="upload_ea_price">EA Price (Upload)<span class="sort-indicator"></span></th>
                                    <th data-sort="same_mfg_part_num">Exact MFN Match<span class="sort-indicator"></span></th>
                                    <th data-sort="weighted_score">Confidence<span class="sort-indicator"></span></th>
                                    <th>False Positive</th>
                                    <th data-sort="description_infor" class="description-col">Description (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="Description" class="description-col">Description (Upload)<span class="sort-indicator"></span></th>
                                    <th data-sort="contract_number_infor">Contract Number (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="manufacturer_name_infor">Manufacturer (Infor)<span class="sort-indicator"></span></th>
                                    <th data-sort="File_Row">File Row (Upload)<span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody-4-1">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-matches-message-4-1" class="no-matches" style="display:none;">
                        <h4>No items found in this confidence level</h4>
                        <p>Please select a different confidence level or adjust your filters.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons-4-1" class="action-buttons">
            <button id="complete-step-4-1-btn" class="btn btn-success">Complete Infor Contract Line Matching, Proceed ...</button>
        </div>
    </div>

    <!-- Step 4.2: Match to Item Master -->
    <div id="step-4-2-content" style="display: none;">
        <h3>Step 4.2: Match to Item Master</h3>
        <p>Match uploaded items against the Infor Item Master database to identify existing items.</p>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4" style = "display: none;">
            <button id="start-item-master-matching-btn" class="btn btn-primary">
                Start Matching to Item Master
            </button>
        </div>
        
        <!-- Item Master Matching Results -->
        <div id="item-master-results-container" class="result-summary" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 15px;">Upload - Item Master Matching Results</h4>
            <!-- Summary statistics will be shown here -->
            <div id="item-master-stats"></div>
        </div>
        
        <!-- Item Master Table Container -->
        <div id="item-master-table-container" style="display: none;">
            <div class="controls-container">
                <div class="filter-container">
                    <div class="search-wrapper">
                        <select id="item-search-type-4-2" class="search-type-select">
                            <option value="contains">Contains</option>
                            <option value="not-contains">Not Contains</option>
                        </select>
                        <input type="text" id="item-search-4-2" class="search-input" placeholder="Filter items...">
                        <button type="button" id="clear-search-btn-4-2" class="clear-search-btn" title="Clear search">Clear</button>
                    </div>
                </div>
                <div class="batch-controls">
                    <button id="select-all-btn-4-2" class="btn btn-sm btn-secondary">Select All</button>
                    <button id="deselect-all-btn-4-2" class="btn btn-sm btn-secondary">Deselect All</button>
                    <button id="save-selections-btn-4-2" class="btn btn-sm btn-primary">Save Selections</button>
                </div>
            </div>
            
            <div class="items-table-container">
                <table id="items-table-4-2" class="items-table">
                    <thead>
                         <tr>
                            <th data-sort="item_number_infor">Infor Item #<span class="sort-indicator"></span></th>
                            <th data-sort="mfg_part_num_infor">Mfg Part Num (Infor)<span class="sort-indicator"></span></th>
                            <th data-sort="Mfg_Part_Num">Mfg Part Num (Upload)<span class="sort-indicator"></span></th>
                            <th data-sort="same_mfg_part_num">Exact MFN Match<span class="sort-indicator"></span></th>
                            <th>False Positive</th>
                            <th data-sort="erp_vendor_id_infor">Vendor ID (Infor)<span class="sort-indicator"></span></th>
                            <th data-sort="ERP_Vendor_ID">Vendor ID (Upload)<span class="sort-indicator"></span></th>
                            <th data-sort="description_infor" class="description-col">Description (Infor)<span class="sort-indicator"></span></th>
                            <th data-sort="Description" class="description-col">Description (Upload)<span class="sort-indicator"></span></th>
                            <th data-sort="File_Row">File Row (Upload)<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody-4-2">
                        <!-- Items will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-matches-message-4-2" class="no-matches" style="display:none;">
                <h4>No Item Master matches found</h4>
                <p>No matches were found between your uploaded items and the Item Master.</p>
            </div>
        </div>


        <!-- Action Buttons -->
        <div id="action-buttons-4-2" class="action-buttons">
            <button id="complete-step-4-2-btn" class="btn btn-success">Complete Item Master Matching, Proceed ...</button>
        </div>
    </div>

    <!-- Placeholder for Step 4.3 -->
    <div id="step-4-3-content" style="display: none;">
        <h3>Step 4.3: UOM/QOE Validation</h3>
        <p>Validate UOM and QOE values against Infor Item Master configurations.</p>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
            <button id="start-uom-qoe-validation-btn" class="btn btn-primary">
                Start UOM/QOE Validation
            </button>
        </div>
        
        <!-- UOM/QOE Validation Results -->
        <div id="uom-qoe-results-container" class="result-summary" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 15px;">UOM/QOE Validation Results</h4>
            <div class="summary-stats-row">
                <div class="summary-stats-column">
                    <div class="summary-stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Items Validated</h5>
                            <div class="stat-value" id="total-items-validated">0</div>
                            <div class="text-muted">Total items with Infor Item #</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card need-review-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">UOM Discrepancies</h5>
                            <div class="stat-value" id="uom-discrepancies">0</div>
                            <div class="text-muted">Items with incorrect UOM</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card need-review-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">QOE Discrepancies</h5>
                            <div class="stat-value" id="qoe-discrepancies">0</div>
                            <div class="text-muted">Items with incorrect QOE</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Discrepancies Table -->
        <div id="uom-qoe-table-container" style="display: none;">
            <div class="controls-container">
                <div class="filter-container">
                    <div class="search-wrapper">
                        <select id="uom-qoe-search-type" class="search-type-select">
                            <option value="contains">Contains</option>
                            <option value="not-contains">Not Contains</option>
                        </select>
                        <input type="text" id="uom-qoe-search" class="search-input" placeholder="Filter items...">
                        <button type="button" id="clear-uom-qoe-search-btn" class="clear-search-btn" title="Clear search">Clear</button>
                    </div>
                </div>
            </div>
            
            <div class="items-table-container">
                <table id="uom-qoe-table" class="items-table">
                    <thead>
                        <tr>
                            <th data-sort="file_row">File Row<span class="sort-indicator"></span></th>
                            <th data-sort="item_number">Infor Item #<span class="sort-indicator"></span></th>
                            <th data-sort="item_description">Description<span class="sort-indicator"></span></th>
                            <th data-sort="upload_uom">Upload UOM<span class="sort-indicator"></span></th>
                            <th data-sort="upload_qoe">Upload QOE<span class="sort-indicator"></span></th>
                            <th data-sort="discrepancy_type">Discrepancy Type<span class="sort-indicator"></span></th>
                            <th>Valid UOMs/QOEs<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="uom-qoe-tbody">
                        <!-- Items will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-discrepancies-message" class="no-matches" style="display:none;">
                <h4>No UOM/QOE discrepancies found</h4>
                <p>All matched items have correct UOM and QOE values.</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons-4-3" class="action-buttons" style="display: none;">
            <button id="generate-correction-file-btn" class="btn btn-secondary me-2">Generate Correction File</button>
            <form id="complete-step-4-3-form" method="POST" action="/process-step/4" style="display: inline;">
                <input type="hidden" name="substep_completed" value="4.3">
                <button type="submit" class="btn btn-success">Complete UOM/QOE Validation</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements for Step 4.1
    const startInforCLMatchingBtn = document.getElementById('start-infor-cl-matching-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const itemComparisonContainer = document.getElementById('item-comparison-container-4-1');
    const comparisonResultsContainer = document.getElementById('comparison-results-container-4-1');
    const itemsDetailView = document.getElementById('items-detail-view-4-1');
    const detailTitle = document.getElementById('detail-title-4-1');
    const itemsTable = document.getElementById('items-table-4-1');
    const itemsTbody = document.getElementById('items-tbody-4-1');
    const noMatchesMessage = document.getElementById('no-matches-message-4-1');
    const actionButtons = document.getElementById('action-buttons-4-1');
    const itemSearchInput = document.getElementById('item-search-4-1');
    const itemSearchType = document.getElementById('item-search-type-4-1');
    const clearSearchBtn = document.getElementById('clear-search-btn-4-1');
    const step42Placeholder = document.getElementById('step-4-2-placeholder');
    const reviewSummaryCard = document.getElementById('review-summary-card-4-1');

    // Add debug logs to check if elements exist
    console.log("Element check:", {
        loadingOverlay: !!loadingOverlay,
        itemComparisonContainer: !!itemComparisonContainer,
        actionButtons: !!actionButtons,
        reviewSummaryCard: !!reviewSummaryCard,
        step42Placeholder: !!step42Placeholder,
        noMatchesMessage: !!noMatchesMessage,
        itemsDetailView: !!itemsDetailView
    });

    // Action buttons
    const selectAllBtn = document.getElementById('select-all-btn-4-1');
    const deselectAllBtn = document.getElementById('deselect-all-btn-4-1');
    const saveSelectionsBtn = document.getElementById('save-selections-btn-4-1');
    
    // Add debug logs to check if buttons exist
    console.log("Button elements:", {
        selectAllBtn: !!selectAllBtn,
        deselectAllBtn: !!deselectAllBtn,
        saveSelectionsBtn: !!saveSelectionsBtn
    });

    // Start matching button click handler
    if (startInforCLMatchingBtn) {
        startInforCLMatchingBtn.addEventListener('click', function() {
            // Show loading overlay
            safeSetDisplay(loadingOverlay, 'flex');
            
            // Hide any previous results
            safeSetDisplay(itemComparisonContainer, 'none');
            safeSetDisplay(actionButtons, 'none');
            safeSetDisplay(reviewSummaryCard, 'none');

            fetch('/item-matching/match-infor-contract-lines', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading overlay
                safeSetDisplay(loadingOverlay, 'none');
                
                if (data.success) {
                    try {
                        // Process results similar to step2
                        if (data.result) {
                            processMatchResults(data.result);
                            // Show the comparison container
                            safeSetDisplay(itemComparisonContainer, 'block');
                            // Show action buttons
                            safeSetDisplay(actionButtons, 'block');
                            // Show placeholder for next step
                            safeSetDisplay(step42Placeholder, 'block');
                            
                        } else {
                            showError("No result data returned from server");
                        }
                    } catch (err) {
                        showError("Error processing results: " + err.message);
                        console.error("Processing error details:", err);
                    }
                } else {
                    showError("Error matching to Infor Contract Lines: " + data.message);
                }
            })
            .catch(error => {
                safeSetDisplay(loadingOverlay, 'none');
                showError("Error during fetch: " + error.toString());
                console.error("Full error details:", error);
            });
        });
    } else {
        console.error("Start button for Infor CL matching not found in DOM");
    }

    // Confidence card click handlers
    document.querySelectorAll('.confidence-card').forEach(card => {
        card.addEventListener('click', function() {
            const level = this.dataset.level;
            loadConfidenceItems(level);
        });
    });
    
    // Table header click for sorting
    document.querySelectorAll('#items-table-4-1 th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
            const field = this.dataset.sort;
            
            if (field === sortField) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('#items-table-4-1 th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            this.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Re-render the table with new sort
            renderItemsTable(currentItems);
        });
    });

    // Filter input handler
    itemSearchInput.addEventListener('input', filterItemTable);
    itemSearchType.addEventListener('change', filterItemTable);
    
    // Clear search button handler
    clearSearchBtn.addEventListener('click', function() {
        itemSearchInput.value = '';
        itemSearchType.value = 'contains'; // Reset to default
        filterItemTable();
    });

    // Select/Deselect all buttons
    selectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('#items-tbody-4-1 input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('#items-tbody-4-1 input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    
    // Save selections button - reimplement the event listener with proper error handling
    if (saveSelectionsBtn) {
        console.log("Adding click listener to save-selections-btn-4-1");
        saveSelectionsBtn.addEventListener('click', function(e) {
            console.log("Save selections clicked");
            e.preventDefault();
            saveSelections();
        });
    } else {
        console.error("Save selections button not found - This is the issue!");
    }

    // Items and filtering variables
    let allItems = []; // All items from backend
    let currentItems = []; // Items for current confidence level
    let currentLevel = null;
    let sortField = null;
    let sortDirection = 'asc';


    // Helper function to safely set display style
    function safeSetDisplay(element, displayValue) {
        if (element && typeof element.style !== 'undefined') {
            element.style.display = displayValue;
        } else {
            // Better error message that doesn't trigger too many warnings in the console
            if (!element) {
                console.warn("Element not found for safeSetDisplay");
            } else if (!element.style) {
                console.warn("Element found but has no style property:", element);
            }
        }
    }

    // Process results from backend and categorize by confidence
    function processMatchResults(result) {
        // Initialize with empty arrays to handle missing data
        allItems = {
            high: [],
            medium: [],
            low: []
        };

        let summaryData = null;
        if (result.summary) {
            summaryData = result.summary;
            console.log("Summary data found:", summaryData);
        } else {
            console.warn("No summary data found in the result.");
        }
        
        try {
            // Safely assign arrays
            if (Array.isArray(result.high)) allItems.high = result.high;
            if (Array.isArray(result.medium)) allItems.medium = result.medium;
            if (Array.isArray(result.low)) allItems.low = result.low;
            
            // Log the data structure to help with debugging
            console.log("Processed items by confidence level:", {
                high: allItems.high.length,
                medium: allItems.medium.length,
                low: allItems.low.length
            });
            
            // Update summary counts with safe defaults
            document.getElementById('high-count-4-1').textContent = allItems.high.length;
            document.getElementById('medium-count-4-1').textContent = allItems.medium.length;
            document.getElementById('low-count-4-1').textContent = allItems.low.length;
            
            // Check for false positives if that field is used
            const highFalsePositives = countFalsePositives(allItems.high);
            const mediumFalsePositives = countFalsePositives(allItems.medium);
            const lowFalsePositives = countFalsePositives(allItems.low);
            
            document.getElementById('high-false-positive-count-4-1').textContent = 
                highFalsePositives + ' marked as false positive';
            document.getElementById('medium-false-positive-count-4-1').textContent = 
                mediumFalsePositives + ' marked as false positive';
            document.getElementById('low-false-positive-count-4-1').textContent = 
                lowFalsePositives + ' marked as false positive';
            
            // Load appropriate confidence level items
            if (allItems.high.length > 0) {
                loadConfidenceItems('high');
            } else if (allItems.medium.length > 0) {
                loadConfidenceItems('medium');
            } else if (allItems.low.length > 0) {
                loadConfidenceItems('low');
            } else {
                // No items found
                safeSetDisplay(noMatchesMessage, 'block');
                safeSetDisplay(itemsDetailView, 'block');
                safeSetDisplay(document.querySelector('.items-table-container'), 'none');
            }

            // IMPORTANT: Only call this once with the server data
            updateAndShowReviewSummary(summaryData);
            
        } catch (err) {
            console.error("Error in processMatchResults:", err);
            showError("Error processing match results: " + err.message);
        }
    }

    // Count false positives in items array
    function countFalsePositives(items) {
        return items.filter(item => item.false_positive).length;
    }
    
    // Function to load items for a confidence level
    function loadConfidenceItems(level) {
        // Update selected card
        document.querySelectorAll('.confidence-card').forEach(card => {
            card.classList.remove('selected');
        });
        const selectedCard = document.getElementById(level + '-confidence-card-4-1');
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        // Update level title
        if (detailTitle) {
            detailTitle.textContent = level.charAt(0).toUpperCase() + level.slice(1) + ' Confidence Matches';
        }
        
        // Set current level and items
        currentLevel = level;
        currentItems = allItems[level] || [];
        
        // Reset sorting and filtering
        sortField = null;
        sortDirection = 'asc';
        document.querySelectorAll('#items-table-4-1 th').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Render items
        renderItemsTable(currentItems);
        
        // Show the detail view
        safeSetDisplay(itemsDetailView, 'block');
        
        // Show/hide no matches message
        safeSetDisplay(noMatchesMessage, currentItems.length === 0 ? 'block' : 'none');
        
        // Get the table container and safely set its display
        const tableContainer = document.querySelector('.items-table-container');
        safeSetDisplay(tableContainer, currentItems.length === 0 ? 'none' : 'block');

        // Clear any existing filter
        if (itemSearchInput) {
            itemSearchInput.value = '';
            filterItemTable();
        }
    }

    // Function to render the items table
    function renderItemsTable(items) {
        itemsTbody.innerHTML = ''; // Clear the table
        
        try {
            // Sort items if sort field is set
            if (sortField) {
                items = [...items].sort((a, b) => {
                    let valA = a[sortField];
                    let valB = b[sortField];
                    
                    // Handle null, undefined, and NaN values
                    if (valA === null || valA === undefined || (typeof valA === 'number' && isNaN(valA))) valA = '';
                    if (valB === null || valB === undefined || (typeof valB === 'number' && isNaN(valB))) valB = '';
                    
                    // Handle numeric fields
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return sortDirection === 'asc' ? valA - valB : valB - valA;
                    }
                    
                    // Handle string fields
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                    
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Add rows to table
            items.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Get confidence class based on score and level
                const scoreClass = currentLevel === 'high' ? 'high-score' : 
                                (currentLevel === 'medium' ? 'medium-score' : 'low-score');
                
                // Format EA prices with safeguards - Use upload_ea_price and infor_ea_price
                const uploadEAPrice = item.upload_ea_price !== null && !isNaN(parseFloat(item.upload_ea_price)) ? 
                    '$' + parseFloat(item.upload_ea_price).toFixed(2) : 'N/A';
                    
                const inforEAPrice = item.infor_ea_price !== null && !isNaN(parseFloat(item.infor_ea_price)) ? 
                    '$' + parseFloat(item.infor_ea_price).toFixed(2) : 'N/A';
                
                // Is exact match with safeguard
                const isExactMatch = item.same_mfg_part_num === 1;
                const matchClass = isExactMatch ? 'match' : 'partial-match';
                
                // Safely calculate display confidence score
                let confidenceScore = '50%'; // Default value
                if (typeof item.weighted_score === 'number' && !isNaN(item.weighted_score)) {
                    confidenceScore = Math.round(item.weighted_score * 100) + '%';
                } else {
                    // Use confidence level as fallback
                    confidenceScore = currentLevel === 'high' ? '90%' : (currentLevel === 'medium' ? '70%' : '50%');
                }
                
                // Safely handle descriptions with optional chaining
                const uploadDesc = item.Description || 'N/A';
                const inforDesc = item.description_infor || 'N/A';
                
                row.innerHTML = `
                    <td>${item.item_number_infor || ''}</td>
                    <td>${item.mfg_part_num_infor || 'N/A'}</td>
                    <td>${item.Mfg_Part_Num || 'N/A'}</td>
                    <td>${item.uom_infor || 'N/A'}</td>
                    <td>${item.UOM || 'N/A'}</td>
                    <td>${item.qoe_infor || 'N/A'}</td>
                    <td>${item.QOE || 'N/A'}</td>
                    <td>${inforEAPrice}</td>
                    <td>${uploadEAPrice}</td>
                    <td><span class="match-indicator ${matchClass}"></span></td>
                    <td class="score-cell ${scoreClass}">${confidenceScore}</td>
                    <td>
                        <input type="checkbox" class="false-positive-checkbox" 
                            data-index="${index}" 
                            ${item.false_positive ? 'checked' : ''}>
                    </td>
                    <td class="description-col" title="${inforDesc}">${inforDesc.substring(0, 50)}${inforDesc.length > 50 ? '...' : ''}</td>
                    <td class="description-col" title="${uploadDesc}">${uploadDesc.substring(0, 50)}${uploadDesc.length > 50 ? '...' : ''}</td>
                    <td>${item.contract_number_infor || 'N/A'}</td>
                    <td>${item.manufacturer_name_infor || 'N/A'}</td>
                    <td>${item.File_Row || 'N/A'}</td>
                `;
                
                itemsTbody.appendChild(row);
            });
        } catch (err) {
            console.error("Error rendering table:", err);
            showError("Error rendering results: " + err.message);
        }
    }

    // Function to filter items based on search input
    function filterItemTable() {
        const searchTerm = itemSearchInput.value.toLowerCase();
        const searchType = itemSearchType.value;
        const tableRows = document.querySelectorAll('#items-tbody-4-1 tr');
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchesContains = text.includes(searchTerm);
            
            // Show/hide based on search type
            if (searchType === 'contains') {
                row.style.display = matchesContains ? '' : 'none';
            } else { // not-contains
                row.style.display = matchesContains ? 'none' : '';
            }
        });
    }

    // Function to save selections (for false positives in 4.1)
    function saveSelections() {
        console.log("saveSelections function called");
        // Show loading overlay
        safeSetDisplay(loadingOverlay, 'flex');
        
        // Get all checkboxes and their status
        const checkboxes = document.querySelectorAll('#items-tbody-4-1 input[type="checkbox"]');
        
        // Create a map of all items and their status
        const itemUpdates = Array.from(checkboxes).map(checkbox => {
            const row = checkbox.closest('tr');
            const fileRow = row.querySelector('td:nth-child(17)').textContent.trim(); // File Row is now in column 17
            const inforMfn = row.querySelector('td:nth-child(2)').textContent.trim(); // Infor MFN is in column 2
            const itemNumber = row.querySelector('td:nth-child(1)').textContent.trim(); // Infor Item # is in column 1
            
            return {
                index: parseInt(checkbox.dataset.index),
                is_false_positive: checkbox.checked,
                file_row: fileRow,
                infor_mfn: inforMfn,
                item_number: itemNumber
            };
        });
        
        // Update the items in memory for immediate UI update
        itemUpdates.forEach(update => {
            if (update.index < currentItems.length) {
                currentItems[update.index].false_positive = update.is_false_positive;
                allItems[currentLevel][update.index].false_positive = update.is_false_positive;
            }
        });
        
        // Create a list of false positive items for the backend
        const falsePositiveItems = itemUpdates.map(update => ({
            file_row: update.file_row,
            infor_mfn: update.infor_mfn,
            is_false_positive: update.is_false_positive
        }));
        
        // Send updates to the backend
        fetch('/item-matching/update-infor-cl-false-positives', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                false_positive_items: falsePositiveItems
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the summary with latest data from server
                if (data.summary) {
                    console.log("Received updated summary from server:", data.summary);
                    updateAndShowReviewSummary(data.summary);
                }
                
                // Update the counts in the UI
                const highFalsePositives = countFalsePositives(allItems.high);
                const mediumFalsePositives = countFalsePositives(allItems.medium);
                const lowFalsePositives = countFalsePositives(allItems.low);
                
                document.getElementById('high-false-positive-count-4-1').textContent = 
                    highFalsePositives + ' marked as false positive';
                document.getElementById('medium-false-positive-count-4-1').textContent = 
                    mediumFalsePositives + ' marked as false positive';
                document.getElementById('low-false-positive-count-4-1').textContent = 
                    lowFalsePositives + ' marked as false positive';
                
                // Hide loading and show success message
                safeSetDisplay(loadingOverlay, 'none');
                alert('Selections saved successfully');
            } else {
                // Show error message
                safeSetDisplay(loadingOverlay, 'none');
                alert('Error saving selections: ' + data.message);
            }
        })
        .catch(error => {
            safeSetDisplay(loadingOverlay, 'none');
            console.error('Error saving selections:', error);
            alert('Error saving selections: ' + error);
        });
    }

    // Function to update and show the review summary card
    function updateAndShowReviewSummary(summaryData = null) {
        let needReviewCount = 0;
        let noReviewCount = 0;
        let itemMasterCount = 0;
        
        if (summaryData && typeof summaryData === 'object') {
            // Use backend summary data if available
            needReviewCount = summaryData.review_count || 0;
            noReviewCount = summaryData.no_need_review_count || 0;
            itemMasterCount = summaryData.item_master_count || 0;
            
            console.log("Setting from summary data - Review:", needReviewCount, 
                        "No Review:", noReviewCount, "Item Master:", itemMasterCount);
        } else {
            console.log("No valid summary data provided, calculating locally");
            // Fall back to calculating from local data
            const needReviewItems = [
                ...allItems.medium.filter(item => !item.false_positive), 
                ...allItems.low.filter(item => !item.false_positive)
            ];
            
            const noReviewItems = allItems.high.filter(item => !item.false_positive);
            
            // Count items with Infor Item Number
            const itemMasterItems = allItems.high.concat(allItems.medium, allItems.low)
                .filter(item => item.item_number_infor && item.item_number_infor !== 'N/A' && !item.false_positive);
            
            needReviewCount = needReviewItems.length;
            noReviewCount = noReviewItems.length;
            itemMasterCount = itemMasterItems.length;
            
            console.log("Calculated locally - Review:", needReviewCount, 
                        "No Review:", noReviewCount, "Item Master:", itemMasterCount);
        }
        
        // Set the values in the UI - ensure they're all numbers and elements exist
        const needReviewElement = document.getElementById('need-review-count-4-1');
        const noReviewElement = document.getElementById('no-need-review-count-4-1');
        const itemMasterElement = document.getElementById('item-master-count-4-1');
        
        if (needReviewElement) needReviewElement.textContent = Number(needReviewCount);
        if (noReviewElement) noReviewElement.textContent = Number(noReviewCount);
        if (itemMasterElement) itemMasterElement.textContent = Number(itemMasterCount);
        
        // Extra check to confirm values were set
        console.log("Values after setting to DOM:", {
            review: needReviewElement ? needReviewElement.textContent : 'element not found',
            noReview: noReviewElement ? noReviewElement.textContent : 'element not found',
            itemMaster: itemMasterElement ? itemMasterElement.textContent : 'element not found'
        });
        
        // Show the review summary card
        safeSetDisplay(reviewSummaryCard, 'block');
    }

    // Function to show errors
    function showError(message) {
        console.error(message);
        alert(message);
    }

    // Variables for Step 4.2
    const step42Content = document.getElementById('step-4-2-content');
    const startItemMasterMatchingBtn = document.getElementById('start-item-master-matching-btn');
    const itemMasterResultsContainer = document.getElementById('item-master-results-container');
    const itemMasterTableContainer = document.getElementById('item-master-table-container');
    const itemMasterStats = document.getElementById('item-master-stats');
    const itemsTable42 = document.getElementById('items-table-4-2');
    const itemsTbody42 = document.getElementById('items-tbody-4-2');
    const noMatchesMessage42 = document.getElementById('no-matches-message-4-2');
    const actionButtons42 = document.getElementById('action-buttons-4-2');
    const itemSearchInput42 = document.getElementById('item-search-4-2');
    const itemSearchType42 = document.getElementById('item-search-type-4-2');
    const clearSearchBtn42 = document.getElementById('clear-search-btn-4-2');
    const step43Placeholder = document.getElementById('step-4-3-placeholder');

    // Items and filtering variables for Step 4.2
    let allItemMasterItems = [];
    let sortField42 = null;
    let sortDirection42 = 'asc';

    // When Step 4.1 is completed, show Step 4.2
    // Replace the existing completeStep41Btn click handler with this version

    // When Step 4.1 is completed, show Step 4.2 and automatically start Item Master matching
    const completeStep41Btn = document.getElementById('complete-step-4-1-btn');
    if (completeStep41Btn) {
        completeStep41Btn.addEventListener('click', function() {
            // Show loading overlay
            safeSetDisplay(loadingOverlay, 'flex');
            
            // Show Step 4.2 but keep Step 4.1 visible
            safeSetDisplay(document.getElementById('step-4-2-content'), 'block');
            
            // Optional: Scroll to the Step 4.2 section smoothly
            document.getElementById('step-4-2-content').scrollIntoView({ behavior: 'smooth' });
            
            // Directly call the Item Master matching endpoint (skip the "Start Matching" button)
            fetch('/item-matching/match-item-master', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                safeSetDisplay(loadingOverlay, 'none');
                
                if (data.success) {
                    try {
                        // Process results
                        processItemMasterResults(data.result);
                        // Show the table container
                        safeSetDisplay(itemMasterTableContainer, 'block');
                        // Show action buttons
                        safeSetDisplay(actionButtons42, 'block');
                        // Show placeholder for next step
                        safeSetDisplay(step43Placeholder, 'block');
                        
                        // Hide the now-redundant "Start Matching to Item Master" button
                        safeSetDisplay(startItemMasterMatchingBtn, 'none');
                    } catch (err) {
                        showError("Error processing Item Master results: " + err.message);
                        console.error("Processing error details:", err);
                    }
                } else {
                    showError("Error matching to Item Master: " + data.message);
                }
            })
            .catch(error => {
                safeSetDisplay(loadingOverlay, 'none');
                showError("Error during fetch: " + error.toString());
                console.error("Full error details:", error);
            });
        });
    }

    // Start matching button click handler for Item Master
    if (startItemMasterMatchingBtn) {
        startItemMasterMatchingBtn.addEventListener('click', function() {
            safeSetDisplay(loadingOverlay, 'flex');
            // Hide any previous results
            safeSetDisplay(itemMasterTableContainer, 'none');
            safeSetDisplay(actionButtons42, 'none');
            safeSetDisplay(itemMasterResultsContainer, 'none');

            fetch('/item-matching/match-item-master', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                safeSetDisplay(loadingOverlay, 'none');
                
                if (data.success) {
                    try {
                        // Process results
                        processItemMasterResults(data.result);
                        // Show the table container
                        safeSetDisplay(itemMasterTableContainer, 'block');
                        // Show action buttons
                        safeSetDisplay(actionButtons42, 'block');
                        // Show placeholder for next step
                        safeSetDisplay(step43Placeholder, 'block');
                    } catch (err) {
                        showError("Error processing Item Master results: " + err.message);
                        console.error("Processing error details:", err);
                    }
                } else {
                    showError("Error matching to Item Master: " + data.message);
                }
            })
            .catch(error => {
                safeSetDisplay(loadingOverlay, 'none');
                showError("Error during fetch: " + error.toString());
                console.error("Full error details:", error);
            });
        });
    }
   

    // Process Item Master results
    function processItemMasterResults(results) {
        if (!results) {
            safeSetDisplay(noMatchesMessage42, 'block');
            return;
        }

        // Debug the result structure
        console.log("Item Master results structure:", results);
        
        // Handle different result formats
        let itemsArray = [];
        let totalMatches = 0;
        let uniqueMatches = 0;
        let falsePositiveItems = 0;
        
        // Handle flat array structure in results.items
        if (typeof results === 'object' && results.items) {
            console.log(`Found items array with ${results.items.length} items`);
            
            // Check if items is a flat array (as in your example)
            if (Array.isArray(results.items)) {
                // Just use the array directly, no flattening needed
                itemsArray = results.items;
                console.log(`Using flat array structure with ${itemsArray.length} items`);
            }
            
            // Get stats from server response
            totalMatches = results.total_matches || itemsArray.length;
            uniqueMatches = results.unique_matches || new Set(itemsArray.map(item => item.item_number_infor)).size;
            falsePositiveItems = results.false_positive_count || 0;
        } 
        // If it's an array directly
        else if (Array.isArray(results)) {
            itemsArray = results;
            totalMatches = itemsArray.length;
            uniqueMatches = new Set(itemsArray.map(item => item.item_number_infor)).size;
        } else {
            console.error("Unexpected results format:", results);
            safeSetDisplay(noMatchesMessage42, 'block');
            return;
        }
        
        // Log final items array info
        console.log(`Processed ${itemsArray.length} items for display`);
        
        // Store all items
        allItemMasterItems = itemsArray;
        
        // Display statistics
        itemMasterStats.innerHTML = `
            <div class="summary-stats-row">
                <div class="summary-stats-column">
                    <div class="summary-stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Matches</h5>
                            <div class="stat-value">${totalMatches}</div>
                            <div class="text-muted">Total matched items</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Unique Items</h5>
                            <div class="stat-value">${uniqueMatches}</div>
                            <div class="text-muted">Unique Item Numbers</div>
                        </div>
                    </div>
                </div>
                <div class="summary-stats-column">
                    <div class="summary-stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">False Positive Items</h5>
                            <div class="stat-value">${falsePositiveItems}</div>
                            <div class="text-muted">Items should get excluded</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show summary
        safeSetDisplay(itemMasterResultsContainer, 'block');
        
        // Make sure tables and containers are visible
        const itemsTableContainer = document.querySelector('#item-master-table-container .items-table-container');
        if (itemsTableContainer) {
            safeSetDisplay(itemsTableContainer, 'block');
        } else {
            console.warn("Could not find #item-master-table-container .items-table-container");
        }
        
        // Reset sorting
        sortField42 = null;
        sortDirection42 = 'asc';
        document.querySelectorAll('#items-table-4-2 th').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Render the table
        renderItemMasterTable(allItemMasterItems);
        
        // Force display the table container after a slight delay to ensure rendering is complete
        setTimeout(() => {
            safeSetDisplay(itemMasterTableContainer, 'block');
            safeSetDisplay(document.querySelector('#item-master-table-container .items-table-container'), 'block');
            console.log("Forced display of item master table container");
        }, 200);
    }

    // Render the Item Master table
    function renderItemMasterTable(items) {
        itemsTbody42.innerHTML = ''; // Clear the table
        
        try {
            // Sort items if needed
            if (sortField42) {
                items = [...items].sort((a, b) => {
                    let valA = a[sortField42];
                    let valB = b[sortField42];
                    
                    // Handle null, undefined, and NaN values
                    if (valA === null || valA === undefined || (typeof valA === 'number' && isNaN(valA))) valA = '';
                    if (valB === null || valB === undefined || (typeof valB === 'number' && isNaN(valB))) valB = '';
                    
                    // Handle numeric fields
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return sortDirection42 === 'asc' ? valA - valB : valB - valA;
                    }
                    
                    // Handle string fields
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                    
                    if (valA < valB) return sortDirection42 === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection42 === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            items.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Is exact match with safeguard
                const isExactMatch = item.same_mfg_part_num === 1;
                const matchClass = isExactMatch ? 'match' : 'partial-match';
                
                // Use item.false_positive property, defaulting to false if not set
                const isFalsePositive = item.false_positive === true;
                
                // Make sure all required data is available for each cell
                const itemNumber = item.item_number_infor || '';
                const inforMfn = item.mfg_part_num_infor || 'N/A';
                const uploadMfn = item.Mfg_Part_Num || 'N/A';
                const inforVendorId = item.erp_vendor_id_infor || 'N/A';
                const fileRow = item.File_Row || 'N/A';
                
                row.innerHTML = `
                    <td>${itemNumber}</td>
                    <td>${inforMfn}</td>
                    <td>${uploadMfn}</td>
                    <td><span class="match-indicator ${matchClass}"></span></td>
                    <td> 
                        <input type="checkbox" class="false-positive-checkbox" 
                            data-index="${index}" 
                            data-file-row="${fileRow}"
                            data-item-number="${itemNumber}"
                            data-infor-mfn="${inforMfn}"
                            data-infor-vendor-id="${inforVendorId}"
                            ${isFalsePositive ? 'checked' : ''}>
                    </td>
                    <td>${inforVendorId}</td>
                    <td>${item.ERP_Vendor_ID || 'N/A'}</td>
                    <td class="description-col" title="${item.description_infor || ''}">${(item.description_infor || 'N/A').substring(0, 50)}${(item.description_infor || '').length > 50 ? '...' : ''}</td>
                    <td class="description-col" title="${item.Description || ''}">${(item.Description || 'N/A').substring(0, 50)}${(item.Description || '').length > 50 ? '...' : ''}</td>
                    <td>${fileRow}</td>
                `;
                
                itemsTbody42.appendChild(row);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('#items-tbody-4-2 input.false-positive-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log(`Checkbox toggled: item ${checkbox.dataset.itemNumber}, file row ${checkbox.dataset.fileRow}, is now ${checkbox.checked ? 'checked' : 'unchecked'}`);
                });
            });
            
        } catch (err) {
            console.error("Error rendering table:", err);
            showError("Error rendering Item Master results: " + err.message);
        }
    }

    // Table header click for sorting - Step 4.2
    document.querySelectorAll('#items-table-4-2 th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
            const field = this.dataset.sort;
            
            if (field === sortField42) {
                sortDirection42 = sortDirection42 === 'asc' ? 'desc' : 'asc';
            } else {
                sortField42 = field;
                sortDirection42 = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('#items-table-4-2 th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            this.classList.add(sortDirection42 === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Re-render the table with new sort
            renderItemMasterTable(allItemMasterItems);
        });
    });

    // Filter input handler - Step 4.2
    itemSearchInput42.addEventListener('input', filterItemMasterTable);
    itemSearchType42.addEventListener('change', filterItemMasterTable);
    
    // Clear search button handler - Step 4.2
    clearSearchBtn42.addEventListener('click', function() {
        itemSearchInput42.value = '';
        itemSearchType42.value = 'contains'; // Reset to default
        filterItemMasterTable();
    });
    
    // Function to filter Item Master table
    function filterItemMasterTable() {
        const searchTerm = itemSearchInput42.value.toLowerCase();
        const searchType = itemSearchType42.value;
        const tableRows = document.querySelectorAll('#items-tbody-4-2 tr');
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchesContains = text.includes(searchTerm);
            
            // Show/hide based on search type
            if (searchType === 'contains') {
                row.style.display = matchesContains ? '' : 'none';
            } else { // not-contains
                row.style.display = matchesContains ? 'none' : '';
            }
        });
    }

    function saveFalsePositiveSelections() {
        console.log("saveFalsePositiveSelections function called"); // Debug log
        // Get the loading overlay directly instead of using a variable that might be out of scope
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Show loading overlay with a safety check
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        } else {
            console.warn('Loading overlay element not found');
        }
        
        // Get all checkboxes and their status
        const checkboxes = document.querySelectorAll('#items-tbody-4-2 input.false-positive-checkbox');
        console.log(`Found ${checkboxes.length} false-positive checkboxes in the table`);
        
        // Create a map of all items and their false positive status with more robust cell access
        const falsePositiveItems = [];
        
        checkboxes.forEach(checkbox => {
            try {
                const row = checkbox.closest('tr');
                if (!row) {
                    console.error("Could not find parent row for checkbox");
                    return;
                }
                
                // Use dataset attributes from the checkbox itself if available
                const fileRow = checkbox.dataset.fileRow || '';
                const itemNumber = checkbox.dataset.itemNumber || '';
                const inforMfn = checkbox.dataset.inforMfn || '';
                const inforVendorId = checkbox.dataset.inforVendorId || '';
                
                // Log what we found for debugging
                console.log("Checkbox data:", {
                    fileRow, itemNumber, inforMfn, inforVendorId, 
                    checked: checkbox.checked
                });
                
                falsePositiveItems.push({
                    file_row: fileRow,
                    item_number: itemNumber,
                    infor_mfn: inforMfn,
                    infor_vendor_id: inforVendorId,
                    is_false_positive: checkbox.checked
                });
            } catch (err) {
                console.error("Error processing checkbox:", err);
            }
        });
        
        // Count how many are checked
        const checkedCount = falsePositiveItems.filter(item => item.is_false_positive).length;
        console.log(`${checkedCount} of ${falsePositiveItems.length} items are marked as false positive`);
        
        // Send updates to the backend
        fetch('/item-matching/update-item-master-false-positives', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                false_positive_items: falsePositiveItems
            })
        })
        .then(response => {
            console.log("Response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Response data:", data);
            
            // Hide loading overlay with a safety check
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            if (data.success) {
                // Update the false positive count
                const falsePositiveElement = document.querySelector('#item-master-stats .summary-stats-row .summary-stats-column:nth-child(3) .stat-value');
                if (falsePositiveElement) {
                    const countToShow = data.false_positive_count !== undefined ? data.false_positive_count : checkedCount;
                    falsePositiveElement.textContent = countToShow;
                    console.log(`Updated false positive count to ${countToShow}`);
                }
                
                alert('False positive selections saved successfully');
            } else {
                alert('Error saving false positive selections: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error saving false positive selections:', error);
            
            // Hide loading overlay with a safety check
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            alert('Error saving selections: ' + error);
        });
    }

    // Fix the event listeners for the buttons
    const selectAllBtn42 = document.getElementById('select-all-btn-4-2');
    const deselectAllBtn42 = document.getElementById('deselect-all-btn-4-2');
    const saveSelectionsBtn42 = document.getElementById('save-selections-btn-4-2');
    
    // Add debug logs to check if buttons exist
    console.log("Button elements for 4-2:", {
        selectAllBtn42: !!selectAllBtn42,
        deselectAllBtn42: !!deselectAllBtn42,
        saveSelectionsBtn42: !!saveSelectionsBtn42
    });
    
    if (selectAllBtn42) {
        selectAllBtn42.addEventListener('click', function() {
            console.log("Select all 4-2 clicked");
            document.querySelectorAll('#items-tbody-4-2 input.false-positive-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    }
    
    if (deselectAllBtn42) {
        deselectAllBtn42.addEventListener('click', function() {
            console.log("Deselect all 4-2 clicked");
            document.querySelectorAll('#items-tbody-4-2 input.false-positive-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    }
    
    if (saveSelectionsBtn42) {
        console.log("Adding click listener to save-selections-btn-4-2");
        saveSelectionsBtn42.addEventListener('click', function(e) {
            console.log("Save selections 4-2 clicked");
            e.preventDefault();
            saveFalsePositiveSelections();
        });
    }

    // Enhance the renderItemMasterTable function to ensure checkboxes have proper data attributes
    function renderItemMasterTable(items) {
        itemsTbody42.innerHTML = ''; // Clear the table
        
        try {
            // Sort items if needed
            // ...existing code...

            items.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Is exact match with safeguard
                const isExactMatch = item.same_mfg_part_num === 1;
                const matchClass = isExactMatch ? 'match' : 'partial-match';
                
                // Use item.false_positive property, defaulting to false if not set
                               const isFalsePositive = item.false_positive === true;
                
                // Make sure all required data is available for each cell
                const itemNumber = item.item_number_infor || '';
                const inforMfn = item.mfg_part_num_infor || 'N/A';
                const uploadMfn = item.Mfg_Part_Num || 'N/A';
                const inforVendorId = item.erp_vendor_id_infor || 'N/A';
                const fileRow = item.File_Row || 'N/A';
                
                row.innerHTML = `
                    <td>${itemNumber}</td>
                    <td>${inforMfn}</td>
                    <td>${uploadMfn}</td>
                    <td><span class="match-indicator ${matchClass}"></span></td>
                    <td> 
                        <input type="checkbox" class="false-positive-checkbox" 
                            data-index="${index}" 
                            data-file-row="${fileRow}"
                            data-item-number="${itemNumber}"
                            data-infor-mfn="${inforMfn}"
                            data-infor-vendor-id="${inforVendorId}"
                            ${isFalsePositive ? 'checked' : ''}>
                    </td>
                    <td>${inforVendorId}</td>
                    <td>${item.ERP_Vendor_ID || 'N/A'}</td>
                    <td class="description-col" title="${item.description_infor || ''}">${(item.description_infor || 'N/A').substring(0, 50)}${(item.description_infor || '').length > 50 ? '...' : ''}</td>
                    <td class="description-col" title="${item.Description || ''}">${(item.Description || 'N/A').substring(0, 50)}${(item.Description || '').length > 50 ? '...' : ''}</td>
                    <td>${fileRow}</td>
                `;
                
                itemsTbody42.appendChild(row);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('#items-tbody-4-2 input.false-positive-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log(`Checkbox toggled: item ${checkbox.dataset.itemNumber}, file row ${checkbox.dataset.fileRow}, is now ${checkbox.checked ? 'checked' : 'unchecked'}`);
                });
            });
            
        } catch (err) {
            console.error("Error rendering table:", err);
            showError("Error rendering Item Master results: " + err.message);
        }
    }

    // Table header click for sorting - Step 4.2
    document.querySelectorAll('#items-table-4-2 th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
            const field = this.dataset.sort;
            
            if (field === sortField42) {
                sortDirection42 = sortDirection42 === 'asc' ? 'desc' : 'asc';
            } else {
                sortField42 = field;
                sortDirection42 = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('#items-table-4-2 th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            this.classList.add(sortDirection42 === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Re-render the table with new sort
            renderItemMasterTable(allItemMasterItems);
        });
    });

    // Filter input handler - Step 4.2
    itemSearchInput42.addEventListener('input', filterItemMasterTable);
    itemSearchType42.addEventListener('change', filterItemMasterTable);
    
    // Clear search button handler - Step 4.2
    clearSearchBtn42.addEventListener('click', function() {
        itemSearchInput42.value = '';
        itemSearchType42.value = 'contains'; // Reset to default
        filterItemMasterTable();
    });
    
    // Function to filter Item Master table
    function filterItemMasterTable() {
        const searchTerm = itemSearchInput42.value.toLowerCase();
        const searchType = itemSearchType42.value;
        const tableRows = document.querySelectorAll('#items-tbody-4-2 tr');
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchesContains = text.includes(searchTerm);
            
            // Show/hide based on search type
            if (searchType === 'contains') {
                row.style.display = matchesContains ? '' : 'none';
            } else { // not-contains
                row.style.display = matchesContains ? 'none' : '';
            }
        });
    }

    // Generate Correction File button handler
    const generateCorrectionFileBtn = document.getElementById('generate-correction-file-btn');
    if (generateCorrectionFileBtn) {
        generateCorrectionFileBtn.addEventListener('click', function() {
            window.location.href = '/download-uom-qoe-discrepancies';
        });
    }
});
</script>