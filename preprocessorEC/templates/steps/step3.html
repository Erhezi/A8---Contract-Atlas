<!-- Duplication Resolution Content -->
<style>
    .draggable-card {
        cursor: move;
        user-select: none;
        margin-bottom: 0.25rem;
    }
    
    /* The last card doesn't need a bottom margin */
    .draggable-card:last-child {
        margin-bottom: 0;
    }
    
    .dragging {
        opacity: 0.5;
        border: 2px dashed #007bff;
    }
    .drag-over {
        border: 2px dashed #ccc; 
    }

    .input-group {
        display: flex;
        width: 100%;
    }
    
    .input-group-prepend {
        display: flex;
    }
    
    .input-group-text {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        margin-bottom: 0;
        font-weight: 400;
        line-height: 1.5;
        color: #495057;
        text-align: center;
        white-space: nowrap;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 0.25rem 0 0 0.25rem;
    }
    
    .input-group select.form-control {
        flex: 1 1 auto;
        width: 1%;
        min-width: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    .priority-ranking-area {
        background-color: #e6f2ff; /* Pale blue background */
        border: 1px solid #cce0ff;
        border-radius: 8px;
        padding: 15px;
        min-height: 200px;
        margin-top: 10px;
    }

    .priority-ranking-area.drag-over {
        background-color: #d9ebff; /* Slightly darker blue when dragging over */
        border: 2px dashed #99c2ff;
    }

    .input-group-append:not(.priority-rank) .input-group-text {
        width: 400px;
        text-align: center; 
        display: flex;
        justify-content: center; 
        align-items: center; 
    }
    
    /* Style for priority rank indicators */
    .priority-rank .input-group-text {
        background-color: #adb5bd;
        color: white;
        font-weight: bold;
        border-radius: 3px;
    }
    
    /* Added styles for results table */
    .table-hover tr.rank-1 {
        background-color: #dff0d8 !important;
    }
    
    .table-hover tr.rank-1:hover {
        background-color: #c1e2b3 !important;
    }
    
    /* Group divider style */
    tr.group-divider td {
        height: 8px;
        padding: 0 !important;
        background-color: #f8f9fa;
    }
    
    /* Smaller font size for results table */
    .table-sm {
        font-size: 0.75rem;
    }

    /* Make headers slightly smaller too */
    .table-sm thead th {
        font-size: 0.8rem;
        white-space: nowrap; 
    }

    /* Description column styling with hover tooltip */
    .table-sm td.description-cell {
        max-width: 250px;
        white-space: nowrap; 
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
        cursor: text;
    }

    /* Tooltip behavior when hovering */
    .table-sm td.description-cell:hover::after {
        content: attr(title);
        position: absolute;
        top: 100%;
        z-index: 1000;
        background-color: #f8f9fa;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        white-space: normal; 
        width: auto;
        min-width: 200px;
        max-width: 400px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Center content in keep*/
    .table-sm .keep-cell {
        text-align: center;
        vertical-align: middle;
    }

    /* Group cell styling */
    .group-cell {
        font-weight: bold;
        background-color: #e9ecef;
    }

    /* Enhanced policy selector styling */
    .policy-option {
        display: flex;
        align-items: center;
    }
    
    .policy-option .policy-icon {
        margin-right: 8px;
    }
    
    .policy-description {
        margin-top: 10px;
        display: none;
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .active-description {
        display: block;
    }

    /* Enhanced Summary Cards Styling - Updated to match Step 2 */
    .summary-stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        width: 100%;
        margin-right: 0;
        margin-left: 0;
        margin-top: 0;
        margin-bottom: 15px;
    }

    .summary-stats-column {
        padding: 0;
    }

    .summary-stat-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-left: 5px solid #3498db;
        height: 100%;
    }

    .summary-stat-card .card-body {
        padding: 10px 15px 10px;
    }

    .summary-stat-card .card-title {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 8px;
        margin-top: 2px;
        font-weight: normal;
    }

    .summary-stat-card .stat-value {
        font-size: 1.7rem;
        font-weight: bold;
        color: #2c3e50;
        margin-top: 0px;
    }

    .total-items-card {
        border-left-color: #3498db; /* Blue */
    }

    .unique-items-card {
        border-left-color: #2ecc71; /* Green */
    }

    .kept-ccx-card {
        border-left-color: #f39c12; /* Orange */
    }

    .kept-uploaded-card {
        border-left-color: #9b59b6; /* Purple */
    }

    .different-value {
        color: red;
        font-weight: bold;
    }

    .moderate-price-difference {
        color: orange;
        font-weight: bold;
    }

    .significant-price-difference {
        color: red;
        font-weight: bold;
    }

    /* When on smaller screens, stack the cards */
    @media (max-width: 767px) {
        .summary-stats-row {
            grid-template-columns: 1fr;
        }
        
        .summary-stats-column {
            margin-bottom: 15px;
        }
    }
</style>


<div class="step-content">
    <p>Resolve the identified duplications.</p>
    <div class="resolution-controls">
        <form id="resolution-form">
            <!-- Resolution UI would go here -->
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Deduplication Policy</span>
                </div>
                <select class="form-control" name="resolution_strategy" id="resolution_strategy">
                    <option value="keep_latest" selected>Keep Latest</option>
                    <option value="keep_lowest_price">Keep Lowest Price</option>
                    <option value="custom">Custom</option>
                    <option value="manual">Manual (Resolve Item by Item)</option>
                </select>
            </div>
            
            <!-- Enhanced policy descriptions -->
            <div id="policy-descriptions" class="mb-3">
                <div id="keep_latest_desc" class="policy-description active-description">
                    <strong>Keep Latest:</strong> Retains the most recent entries from your current upload file, all other items identified from step 2 will be marked as duplicates to be deactivated.
                </div>
                <div id="keep_lowest_price_desc" class="policy-description">
                    <strong>Keep Lowest Price:</strong> Keeps the item with the lowest price when duplicates are found, regardless of which file it's from (if upload file and CCX existing file run into a tie, it will pick up the upload file).
                </div>
                <div id="custom_desc" class="policy-description">
                    <strong>Custom:</strong> Create your own prioritization rules based on contract source, status, price, and expiration date.
                </div>
                <div id="manual_desc" class="policy-description">
                    <strong>Manual:</strong> Set initial priorities using the drag-and-drop interface, then review and adjust individual selections using checkboxes in the results table.
                </div>
            </div>
            
            <div class="form-text text-muted mb-3" style="margin-top: 0.7rem !important;">
                <small>Select the deduplication policy and hit "Apply Resolution" to view resolution results.</small>
            </div>
            
            <!-- Custom deduplication policy options -->
            <div id="custom_policy_options" class="mt-4" style="display: none;">
                <h4>Custom Deduplication Policy</h4>
                <p class="text-muted">Drag and drop the parameters below to set their priority order (Top = Highest Priority). Select/Change your preference within each card using the dropdown list.</p>

                <!-- Hidden fields to store the final priorities and preferences -->
                <input type="hidden" name="contract_source_priority" id="contract_source_priority">
                <input type="hidden" name="contract_source_preference" id="contract_source_preference">
                <input type="hidden" name="unit_price_priority" id="unit_price_priority">
                <input type="hidden" name="unit_price_preference" id="unit_price_preference">
                <input type="hidden" name="contract_status_priority" id="contract_status_priority">
                <input type="hidden" name="contract_status_preference" id="contract_status_preference">
                <input type="hidden" name="expiration_priority" id="expiration_priority">
                <input type="hidden" name="expiration_preference" id="expiration_preference">

                <div id="priority_ranking_area" class="border p-3 rounded priority-ranking-area" style="min-height: 200px;">
                    <!-- Draggable Cards -->
                    <div class="card mb-2 draggable-card" draggable="true" id="card_contract_source">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <div class="input-group-prepend priority-rank">
                                    <span class="input-group-text rank-indicator">1</span>
                                </div>
                                <select class="form-control preference-select" name="contract_source_preference_options" data-parameter="contract_source">
                                    <option value="" selected disabled>Use dropdown to choose...</option>
                                    <option value="gpo_first" selected>GPO First</option>
                                    <option value="local_first">Local First</option>
                                </select>
                                <div class="input-group-append">
                                    <span class="input-group-text">Contract Source Type</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-2 draggable-card" draggable="true" id="card_contract_status">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <div class="input-group-prepend priority-rank">
                                    <span class="input-group-text rank-indicator">2</span>
                                </div>
                                <select class="form-control preference-select" name="contract_status_preference_options" data-parameter="contract_status">
                                    <option value="" selected disabled>Use dropdown to choose...</option>
                                    <option value="new_first" selected>New First</option>
                                    <option value="existing_first">Existing First</option>
                                </select>
                                <div class="input-group-append">
                                    <span class="input-group-text">Contract Status (Source Set)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-2 draggable-card" draggable="true" id="card_unit_price">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <div class="input-group-prepend priority-rank">
                                    <span class="input-group-text rank-indicator">3</span>
                                </div>
                                <select class="form-control preference-select" name="unit_price_preference_options" data-parameter="unit_price">
                                    <option value="" selected disabled>Use dropdown to choose...</option>
                                    <option value="lowest_first" selected>Lowest First</option>
                                    <option value="highest_first">Highest First</option>
                                </select>
                                <div class="input-group-append">
                                    <span class="input-group-text">EA Price</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-2 draggable-card" draggable="true" id="card_expiration">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <div class="input-group-prepend priority-rank">
                                    <span class="input-group-text rank-indicator">4</span>
                                </div>
                                <select class="form-control preference-select" name="expiration_preference_options" data-parameter="expiration">
                                    <option value="" selected disabled>Use dropdown to choose...</option>
                                    <option value="soonest_first">Soonest First</option>
                                    <option value="farthest_first" selected>Farthest First</option>
                                </select>
                                <div class="input-group-append">
                                    <span class="input-group-text">Expiration Proximity</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Draggable Cards -->
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3" id="apply-resolution-btn">Apply Resolution</button>
        </form>
    </div>
    
    <!-- Results Section - Initially Hidden -->
    <div id="deduplication-results" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Deduplication Results</h4>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="summary-stats-row mb-4">
                    <div class="summary-stats-column">
                        <div class="summary-stat-card total-items-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Items</h5>
                                <div class="stat-value" id="stats-total-items">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-stats-column">
                        <div class="summary-stat-card unique-items-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Unique Items</h5>
                                <div class="stat-value" id="stats-unique-items">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-stats-column">
                        <div class="summary-stat-card kept-ccx-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Kept from CCX</h5>
                                <div class="stat-value" id="stats-kept-ccx">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-stats-column">
                        <div class="summary-stat-card kept-uploaded-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Kept from Upload</h5>
                                <div class="stat-value" id="stats-kept-uploaded">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Table -->
                <h5>Duplication Resolution Details</h5>
                <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                    <table class="table table-sm table-bordered table-hover">
                        <thead class="thead-light sticky-top">
                            <tr>
                                <th>G.</th>
                                <th>R.</th>
                                <th class="keep-cell">Keep</th>
                                <th>Set</th>
                                <th>Contract Number</th>
                                <th>Mfg Part Num</th>
                                <th>UOM</th>
                                <th>QOE</th>
                                <th>Price</th>
                                <th>EA Price</th>
                                <th>Effec. Date</th>
                                <th>Expir. Date</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Complete Step Button -->
                <div class="action-buttons" style="margin-top: 20px; text-align: right;">
                    <form method="POST" action="{{ url_for('common.process_step', step_id=3) }}">
                        <input type="hidden" name="resolution_strategy" id="completion_resolution_strategy">
                        <input type="hidden" name="step_completed" value="true">
                        <button type="submit" class="btn btn-success">Complete Step 3</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const resolutionStrategy = document.getElementById('resolution_strategy');
        const customPolicyOptions = document.getElementById('custom_policy_options');
        const priorityRankingArea = document.getElementById('priority_ranking_area');
        const draggableCards = document.querySelectorAll('.draggable-card');
        const preferenceSelects = document.querySelectorAll('.preference-select');
        const resolutionForm = document.getElementById('resolution-form');
        const deduplicationResults = document.getElementById('deduplication-results');
        const completeStepBtn = document.getElementById('complete-step-btn');

        let draggedItem = null;

        // --- Initial Setup ---
        toggleCustomOptions();
        updateHiddenInputs(); // Set initial values based on default order/prefs

        // --- Event Listeners ---
        resolutionStrategy.addEventListener('change', toggleCustomOptions);

        draggableCards.forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });

        priorityRankingArea.addEventListener('dragover', handleDragOver);
        priorityRankingArea.addEventListener('dragenter', handleDragEnter);
        priorityRankingArea.addEventListener('dragleave', handleDragLeave);
        priorityRankingArea.addEventListener('drop', handleDrop);

        preferenceSelects.forEach(select => {
            select.addEventListener('change', updateHiddenInputs);
        });
        
        // Form submission handler
        resolutionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyResolution();
        });
        
        // Complete step button handler
        completeStepBtn.addEventListener('click', function() {
            completeStep();
        });

        // --- Functions ---
        function toggleCustomOptions() {
            // Show custom policy options for both 'custom' and 'manual' modes
            if (resolutionStrategy.value === 'custom' || resolutionStrategy.value === 'manual') {
                customPolicyOptions.style.display = 'block';
                
                // Update the header text based on selected mode
                const policyHeader = customPolicyOptions.querySelector('h4');
                if (policyHeader) {
                    if (resolutionStrategy.value === 'custom') {
                        policyHeader.textContent = 'Custom Deduplication Policy';
                    } else {
                        policyHeader.textContent = 'Manual Deduplication: Initial Priority Settings';
                    }
                }
                
                // Update the description text based on selected mode
                const policyDesc = customPolicyOptions.querySelector('p.text-muted');
                if (policyDesc) {
                    if (resolutionStrategy.value === 'custom') {
                        policyDesc.textContent = 'Drag and drop the parameters below to set their priority order (Top = Highest Priority). Select/Change your preference within each card.';
                    } else {
                        policyDesc.textContent = 'Set initial priorities as a first pass. After applying, you can manually adjust individual selections using checkboxes in the results table.';
                    }
                }
                
                // Show explanation tooltip on first display for each mode
                const storageKey = resolutionStrategy.value === 'custom' ? 'customPolicyExplained' : 'manualPolicyExplained';
                if (!sessionStorage.getItem(storageKey)) {
                    if (resolutionStrategy.value === 'custom') {
                        alert('Custom Policy Guide: Drag and drop parameters to rank them (top is highest priority). Select preferences within each card.');
                    } else {
                        alert('Manual Mode Guide: First set general priorities with drag and drop, then after applying you can override individual selections with checkboxes.');
                    }
                    sessionStorage.setItem(storageKey, 'true');
                }
                
                updateHiddenInputs(); // Ensure inputs are updated when shown
            } else {
                customPolicyOptions.style.display = 'none';
            }
            
            // Update policy description visibility
            const policyDescriptions = document.querySelectorAll('.policy-description');
            policyDescriptions.forEach(desc => desc.classList.remove('active-description'));
            const selectedDesc = document.getElementById(`${resolutionStrategy.value}_desc`);
            if (selectedDesc) {
                selectedDesc.classList.add('active-description');
            }
        }

        // Draggable functions remain unchanged...
        // handleDragStart, handleDragEnd, handleDragOver, handleDragEnter, handleDragLeave, handleDrop, getDragAfterElement, updateHiddenInputs

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging'); // Add class immediately
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.id); // Pass the id
        }

        function handleDragEnd() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            priorityRankingArea.classList.remove('drag-over');
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            
            // Don't manipulate DOM during dragOver - just visual feedback
            priorityRankingArea.classList.add('drag-over');
        }

        function handleDragEnter(e) {
            e.preventDefault(); // Prevent default behavior
            // Optional: Add more specific visual feedback if needed
        }

        function handleDragLeave() {
             priorityRankingArea.classList.remove('drag-over'); // Remove highlight when leaving
        }

        function handleDrop(e) {
            e.preventDefault();
            priorityRankingArea.classList.remove('drag-over');

            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            
            if (!draggable) return;
            
            const afterElement = getDragAfterElement(priorityRankingArea, e.clientY);
            
            // Perform the actual DOM manipulation on drop, not during dragover
            if (afterElement == null) {
                priorityRankingArea.appendChild(draggable);
            } else {
                priorityRankingArea.insertBefore(draggable, afterElement);
            }
            
            draggable.classList.remove('dragging');
            draggedItem = null;
            
            // Update priorities after reordering
            updateHiddenInputs();
        }

        function getDragAfterElement(container, y) {
            // Only consider cards that are not currently being dragged
            const draggableElements = [...container.querySelectorAll('.draggable-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                // If mouse position is above middle of element and this offset is smaller than previous
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateHiddenInputs() {
            const cardsInOrder = priorityRankingArea.querySelectorAll('.draggable-card');
            cardsInOrder.forEach((card, index) => {
                const priority = index + 1; // Priority 1-4 based on order
                const parameterId = card.id.replace('card_', ''); // e.g., 'contract_source'
                const preferenceSelect = card.querySelector('.preference-select');
                const preferenceValue = preferenceSelect && preferenceSelect.value ? preferenceSelect.value : ''; // Get selected preference

                // Update hidden inputs
                document.getElementById(`${parameterId}_priority`).value = priority;
                document.getElementById(`${parameterId}_preference`).value = preferenceValue;
                
                // Update rank indicator
                const rankIndicator = card.querySelector('.rank-indicator');
                if (rankIndicator) {
                    rankIndicator.textContent = priority;
                }
            });
        }
        
        // New functions for deduplication
        function applyResolution() {
            // Show loading indicator
            showSpinner('Applying deduplication policy...');
            
            // Get form data
            const formData = new FormData(resolutionForm);
            
            // Send AJAX request
            fetch('/duplicate-detection/apply-resolution', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideSpinner();
                
                if (data.success) {
                    // Show success message
                    showAlert('success', data.message);
                    
                    // Show results section
                    deduplicationResults.style.display = 'block';
                    
                    // Update statistics
                    document.getElementById('stats-total-items').textContent = data.summary.total_items;
                    document.getElementById('stats-unique-items').textContent = data.summary.unique_duplicates;
                    document.getElementById('stats-kept-ccx').textContent = data.summary.kept_ccx;
                    document.getElementById('stats-kept-uploaded').textContent = data.summary.kept_uploaded;
                    
                    // Fetch and display results
                    fetchDeduplicationResults();
                    
                    // Scroll to results
                    deduplicationResults.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                hideSpinner();
                showAlert('danger', 'An error occurred: ' + error.message);
            });
        }
        
        function fetchDeduplicationResults() {
            fetch('/duplicate-detection/get-deduplication-results')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // for manual mode, initialize kept stats to 0
                    if (resolutionStrategy.value === 'manual') {
                        if(data.data.summary) {
                            data.data.summary.kept_ccx = 0;
                            data.data.summary.kept_uploaded = 0;

                            document.getElementById('stats-kept-ccx').textContent = '0';
                            document.getElementById('stats-kept-uploaded').textContent = '0';
                        }
                    }
                    populateResultsTable(data.data);
                }
            })
            .catch(error => {
                console.error('Error fetching deduplication results:', error);
            });
        }

        function updateManualModeStats() {
            if (resolutionStrategy.value !== 'manual') return;
            
            let keptCCX = 0;
            let keptTP = 0;
            
            // Count checked items by dataset
            document.querySelectorAll('.keep-checkbox:checked').forEach(checkbox => {
                // Get the dataset from the table cell (4th column contains Dataset)
                const row = checkbox.closest('tr');
                const dataset = row.cells[3].textContent.trim();
                
                if (dataset === 'CCX') {
                    keptCCX++;
                } else if (dataset === 'TP') {
                    keptTP++;
                }
            });
            
            // Update the stats display
            document.getElementById('stats-kept-ccx').textContent = keptCCX;
            document.getElementById('stats-kept-uploaded').textContent = keptTP;
        }
        
        function populateResultsTable(data) {
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            
            if (!data.stacked_data || data.stacked_data.length === 0) {
                // Update colspan for empty table message
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center">No results found</td></tr>';
                return;
            }
            
            // Group data by File Row
            const groupedData = {};
            data.stacked_data.forEach(item => {
                const groupId = item['File Row'];
                if (!groupedData[groupId]) {
                    groupedData[groupId] = [];
                }
                groupedData[groupId].push(item);
            });
            
            // Get group IDs and sort
            const groupIds = Object.keys(groupedData);
            
            // Show all groups, not just top 10
            const displayGroups = groupIds;
            
            // Function to format price as currency
            function formatCurrency(value) {
                if (value === null || value === undefined || value === '') {
                    return 'N/A';
                }
                // Parse as float and format with $ and 2 decimal places
                return '$' + parseFloat(value).toFixed(2);
            }
            
            // get CURRENT POLICY
            const currentPolicy = document.getElementById('resolution_strategy').value;

            // Add rows for each group
            displayGroups.forEach((groupId, groupIndex) => {
                // Sort by group ID (File Row)// Sort by rank within group
                groupedData[groupId].sort((a, b) => a['Rank'] - b['Rank']);

                // Store reference value
                const rank1Item = groupedData[groupId].find(i => i['Rank'] === 1);
                const rank1QOE = rank1Item ? rank1Item['QOE'] : null;
                const rank1UOM = rank1Item ? rank1Item['UOM'] : null;
                const rank1EAPrice = rank1Item ? rank1Item['EA Price'] : null;

                // Add group items
                groupedData[groupId].forEach((item, itemIndex) => {
                    const row = document.createElement('tr');
                    
                    // Add 'rank-1' class to highlight kept records
                    if (item['Rank'] === 1) {
                        row.classList.add('rank-1');
                    }
                    

                    // Add Group cell for EVERY row
                    const groupCell = document.createElement('td');
                    groupCell.textContent = groupId;
                    groupCell.classList.add('group-cell');

                    // Only make the text visible for the first row in each group
                    if (itemIndex > 0) {
                        groupCell.style.color = 'transparent'; // Hide text but keep cell structure
                    }
                    row.appendChild(groupCell);
                    
                    // Add Rank cell
                    const rankCell = document.createElement('td');
                    rankCell.textContent = item['Rank'] || '';
                    row.appendChild(rankCell);
                    
                    // --- Add Keep Checkbox Cell (now third column) ---
                    const keepCell = document.createElement('td');
                    keepCell.classList.add('keep-cell');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('keep-checkbox');
                    // Add data attributes to identify the item for potential manual handling later
                    checkbox.dataset.fileRow = item['File Row'];
                    checkbox.dataset.pairId = item['Pair ID']; // Make sure 'Pair ID' exists in your data

                    
                    // Check Rank 1 if policy is not manual
                    if (item['Rank'] === 1) {
                        checkbox.checked = true;
                    }

                    // Disable checkbox if policy is not manual
                    if (currentPolicy !== 'manual') {
                        checkbox.disabled = true;
                    } else {
                        // Add event listener for manual mode
                        checkbox.addEventListener('change', function() {
                            const row = this.closest('tr');
                            const groupID = this.dataset.fileRow;
                            const dataset = item['Dataset'] || ''; // Get dataset name for the row

                            if (this.checked) {
                                // uncheck all other checkboxes in the same group
                                document.querySelectorAll('.keep-checkbox').forEach(cb => {
                                    if (cb !== this && cb.dataset.fileRow === groupID) {
                                        cb.checked = false;
                                        const otherRow = cb.closest('tr');
                                        if (otherRow) {
                                            otherRow.classList.remove('rank-1'); // Remove class from other rows in the group
                                        }
                                    }
                                });
                                
                                row.classList.add('rank-1'); // Add class to highlight selected row
                                if (currentPolicy === 'manual') {
                                    // count selected checkboxes by dataset
                                    updateManualModeStats();
                                }
                            } else {
                                row.classList.remove('rank-1'); // Remove class if unchecked
                                if (currentPolicy === 'manual') {
                                    // count selected checkboxes by dataset
                                    updateManualModeStats();
                                }
                            }
                        });
                    }
 
                    keepCell.appendChild(checkbox);
                    row.appendChild(keepCell);
                    // --- End Keep Checkbox Cell ---
                    
                    // Process description to ensure consistent truncation
                    const description = item['Description'] || '';
                    const truncatedDescription = description.length > 40 ? 
                        description.substring(0, 40) + '...' : description;
                    
                    // Format prices with $ and 2 decimal places
                    const formattedContractPrice = formatCurrency(item['Contract Price']);
                    const formattedEAPrice = formatCurrency(item['EA Price']);
                    
                    // Add remaining cells in the new order
                    const cells = [
                        ['Dataset', item['Dataset']],
                        ['Contract Number', item['Contract Number']],
                        ['Mfg Part Num', item['Mfg Part Num']],
                        ['UOM', item['UOM']],
                        ['QOE', item['QOE']],
                        ['Contract Price', formattedContractPrice],
                        ['EA Price', formattedEAPrice],
                        ['Effective Date', item['Effective Date']],
                        ['Expiration Date', item['Expiration Date']],
                        ['Description', truncatedDescription]
                    ];
                    
                    cells.forEach(([field, value]) => {
                        const cell = document.createElement('td');
                        cell.textContent = value || '';
                        
                        // Add title attribute to Description column for hover tooltip
                        if (field === 'Description') {
                            cell.setAttribute('title', description);
                            cell.classList.add('description-cell');
                        }

                        // highlight the cell if it is different from rank-1 int he same group
                        if (item['Rank'] !== 1 && rank1Item) {
                            if (field === 'QOE' && item['QOE'] !== rank1QOE && rank1QOE !== null) {
                                cell.classList.add('different-value');
                            } else if (field === 'UOM' && item['UOM'] !== rank1UOM && rank1UOM !== null) {
                                cell.classList.add('different-value');
                            } else if (field === 'EA Price' && rank1EAPrice !== null && item['EA Price'] !== null) {
                                // For EA Price, apply different highlighting based on price ratio
                                if (item['EA Price'] !== rank1EAPrice) {
                                    const priceRatio = parseFloat(item['EA Price']) / parseFloat(rank1EAPrice);
                                    
                                    // Check if price is significantly different (>2x or <0.5x)
                                    if (priceRatio >= 2 || priceRatio < 0.5) {
                                        cell.classList.add('significant-price-difference');
                                    } else {
                                        cell.classList.add('moderate-price-difference');
                                    }
                                }
                            }
                        }
                        
                        row.appendChild(cell);
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // Add separator between groups (except after the last group)
                if (groupIndex < displayGroups.length - 1) {
                    const divider = document.createElement('tr');
                    divider.classList.add('group-divider');
                    // Update colspan for divider (still 13 columns total)
                    divider.innerHTML = '<td colspan="13"></td>';
                    tableBody.appendChild(divider);
                }
            });
        }
        
        function completeStep() {
            showSpinner('Completing step 3...');
            
            fetch('/duplicate-detection/complete-step3', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                hideSpinner();
                
                if (data.success) {
                    showAlert('success', data.message);
                    
                    // Redirect to next step
                    setTimeout(() => {
                        window.location.href = data.redirect || '/';
                    }, 1000);
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                hideSpinner();
                showAlert('danger', 'Error completing step: ' + error.message);
            });
        }
        
        // Utility functions
        function showSpinner(message) {
            const existingSpinner = document.getElementById('loading-spinner');
            if (existingSpinner) {
                existingSpinner.remove();
            }
            
            const spinner = document.createElement('div');
            spinner.id = 'loading-spinner';
            spinner.className = 'loading-overlay';
            spinner.style.position = 'fixed';
            spinner.style.top = '0';
            spinner.style.left = '0';
            spinner.style.width = '100%';
            spinner.style.height = '100%';
            spinner.style.backgroundColor = 'rgba(0,0,0,0.4)';
            spinner.style.zIndex = '1000';
            spinner.style.display = 'flex';
            spinner.style.justifyContent = 'center';
            spinner.style.alignItems = 'center';
            
            // Create a simpler spinner without text
            const spinnerElement = document.createElement('div');
            spinnerElement.className = 'spinner-border text-primary';
            spinnerElement.style.width = '3rem';
            spinnerElement.style.height = '3rem';
            spinnerElement.style.borderWidth = '0.25rem';
            spinnerElement.setAttribute('role', 'status');
            
            // Add spinner directly to the overlay
            spinner.appendChild(spinnerElement);
            
            document.body.appendChild(spinner);
        }
        
        function hideSpinner() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.remove();
            }
        }
        
        function showAlert(type, message, timeout = 5000) {
            // Remove existing alerts
            // Use the global alert function from layout.html
            window.showGlobalAlert(type, message, timeout);
        }
    });
</script>

<!-- Control the change of mode explaination -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Policy description toggler
        const policySelect = document.getElementById('resolution_strategy');
        const policyDescriptions = document.querySelectorAll('.policy-description');
        document.getElementById('completion_resolution_strategy').value = document.getElementById('resolution_strategy').value;
        
        policySelect.addEventListener('change', function() {
            // Hide all descriptions
            policyDescriptions.forEach(desc => desc.classList.remove('active-description'));
            
            // Show the selected one
            const selectedDesc = document.getElementById(`${this.value}_desc`);
            if (selectedDesc) {
                selectedDesc.classList.add('active-description');
            }

            // add to the completion resolution strategy
            document.getElementById('completion_resolution_strategy').value = this.value;
        });
    });
</script>