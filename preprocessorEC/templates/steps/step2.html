<!-- Duplication Overview Content -->
<style>
    .contract-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Always 2 columns of equal width */
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .contract-card {
    /* No flex properties needed with grid */
    background-color: #fff;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 5px solid #2ecc71;
    transition: all 0.3s ease;
    cursor: pointer;
    }
    
    .contract-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .contract-card.selected {
        border-left-color: #2ecc71;
    }
    
    .contract-card.excluded {
        border-left-color: #e74c3c;
        opacity: 0.7;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .card-title {
        margin: 0 0 10px 0; /* give bottom 10px margin */
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: bold;
    }
    
    .card-subtitle {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin: 8px 0;
        line-height: 1.4;
    }

    .card-subtitle.manufacturer {
        margin-top: 5px; /* Extra space above manufacturer */
        padding-top: 8px; /* Add padding */
        border-top: 1px dotted #eee; /* Optional: subtle separator */
    }
    
    .card-stats {
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #ecf0f1;
        padding-top: 10px;
        margin-top: 10px;
    }
    
    .card-stat {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #3498db;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #7f8c8d;
    }
    

    .toggle-action-btn {
        font-size: 0.75rem;
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 5px;
        font-weight: 500;
    }
    
    .toggle-action-btn:hover {
        background-color: #e0e0e0;
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.3rem;
    }
    
    .close-btn {
        font-size: 1.5rem;
        cursor: pointer;
        border: none;
        background: none;
    }
    
    .modal-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem; /* Add smaller font size here too */
    }
    
    .modal-table th, .modal-table td {
        padding: 6px 10px; /* Reduce from 8px 12px */
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
    }
    
    /* Add width constraints for description columns in modal table */
    .modal-table th:nth-child(8),
    .modal-table td:nth-child(8),
    .modal-table th:nth-child(9),
    .modal-table td:nth-child(9) {
        max-width: 375px; /* Set a max width for description columns */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Add tooltip behavior for description cells */
    .modal-table td:nth-child(8),
    .modal-table td:nth-child(9) {
        position: relative;
        cursor: text;
    }
    
    .modal-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .modal-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .modal-table tr:hover {
        background-color: #e6f7ff;
    }
    
    .match-indicator {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .match-indicator.match {
        background-color: #d4edda;
        color: #155724;
    }
    
    .match-indicator.mismatch {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    .search-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 300px;
        margin-right: 10px;
    }

    .no-results {
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }


    .contracts-status-section {
        margin: 15px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        display: none; /* Initially hidden */
    }

    .contract-legend {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .color-box {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }

    .included-color {
        background-color: #2ecc71;
    }
    
    .excluded-color {
        background-color: #e74c3c;
    }
    
    .included-contracts {
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .tags-label {
        font-weight: bold;
        margin-top: 5px;
    }
    
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .contract-tag {
        background-color: #e1f5fe;
        color: #0277bd;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        border: 1px solid #b3e5fc;
        white-space: nowrap;
    }
    
    .empty-tag {
        color: #999;
        font-style: italic;
    }

    .status-text {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: inline-block;
        text-align: center;
        min-width: 90px;
    }
    
    .status-included {
        background-color: #28a745;
        color: white;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .status-excluded {
        background-color: #dc3545;
        color: white;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .contract-card.selected .toggle-action-btn {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .contract-card.selected .toggle-action-btn:hover {
        background-color: #e74c3c;
        color: white;
    }
    
    .contract-card.excluded .toggle-action-btn {
        background-color: #d4edda;
        color: #155724;
    }
    
    .contract-card.excluded .toggle-action-btn:hover {
        background-color: #28a745;
        color: white;
    }
    
    /* Improve indicator alignment */
    .status-indicator {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
    }

    .contract-filter-container {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .search-wrapper {
        display: flex;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        height: 38px;
    }
    
    .search-type-select {
        padding: 8px;
        border: none;
        border-right: 1px solid #ddd;
        background-color: #f5f5f5;
        font-size: 0.9rem;
        cursor: pointer;
    }
    

    /* Item-Level Comparison Styles */
    .item-comparison-container {
        display: none; /* Hidden initially, shown after contract review */
        margin-top: 40px;
        border-top: 1px solid #e0e0e0;
        padding-top: 30px;
    }

    .confidence-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .confidence-card {
        flex: 1;
        min-width: 240px;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .confidence-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .confidence-card.selected {
        border: 2px solid #3498db;
    }
    
    .confidence-card.high {
        border-top: 5px solid #2ecc71;
    }
    
    .confidence-card.medium {
        border-top: 5px solid #f39c12;
    }
    
    .confidence-card.low {
        border-top: 5px solid #e74c3c;
    }
    
    .confidence-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .confidence-card.high .confidence-title {
        color: #2ecc71;
    }
    
    .confidence-card.medium .confidence-title {
        color: #f39c12;
    }
    
    .confidence-card.low .confidence-title {
        color: #e74c3c;
    }
    
    .count-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .count-label {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .false-positive-count {
        color: #e74c3c;
        font-size: 0.9rem;
        margin-top: 10px;
    }
    
    .items-table-container {
        margin-top: 20px;
        overflow-x: auto;
        overflow-y: auto; /* Add vertical scrolling */
        max-width: 100%;
        max-height: 700px; /* Limit table height to 700px */
        border: 1px solid #eee; /* Optional: add a subtle border */
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem; 
    }

    .items-table th, 
    .items-table td {
        padding: 6px; /* Reduce padding from 8px to 6px for more compact rows */
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    /* Set equal width for manufacturer part number columns */
    .items-table th:nth-child(1),
    .items-table td:nth-child(1),
    .items-table th:nth-child(2),
    .items-table td:nth-child(2) {
        width: 5%;  /* Set a fixed width for both columns */
        min-width: 80px; /* Ensure a minimum width */
        overflow: hidden;
        text-overflow: ellipsis; /* Show ellipsis for overflow text */
    }
    
    .items-table th {
        background-color: #f5f5f5;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
    }
    
    .items-table th:hover {
        background-color: #e9e9e9;
    }
    
    .items-table tbody tr:hover {
        background-color: #f0f7ff;
    }
    
    .items-table .sort-indicator {
        margin-left: 5px;
        opacity: 0.5;
    }
    
    .items-table th.sort-asc .sort-indicator::after {
        content: "▲";
    }
    
    .items-table th.sort-desc .sort-indicator::after {
        content: "▼";
    }
    
    .controls-container {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .filter-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-input {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 200px;
    }
    
    .batch-controls {
        display: flex;
        gap: 10px;
    }
    
    .score-cell {
        text-align: center;
        font-weight: bold;
    }
    
    .high-score {
        color: #2ecc71;
    }
    
    .medium-score {
        color: #f39c12;
    }
    
    .low-score {
        color: #e74c3c;
    }
    
    .match-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
    
    .match-indicator.match::before {
        content: "✓";
        color: #2ecc71;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .match-indicator.no-match::before {
        content: "✗";
        color: #e74c3c;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .no-matches {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin: 20px 0;
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .clear-search-btn {
        background: #f5f5f5;
        border: none;
        border-left: 1px solid #ddd;
        padding: 0 12px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        min-width: 60px;
    }
    
    .clear-search-btn:hover {
        background: #e0e0e0;
        color: #333;
    }

    .progress-overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 500px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .progress-title {
        margin-bottom: 15px;
        text-align: center;
        color: #333;
    }
    
    .progress {
        height: 25px;
    }
    
    #progress-percentage {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    #progress-message {
        font-size: 0.95rem;
    }
</style>

<div class="step-content">
    <h3>Step 2.1: Contract-Level Duplication Review</h3>
    <p>Review potential duplicate items between your upload and the CCX database. First, review at the contract level to identify which contracts might have matching items.</p>
    
    <div class="contract-filter-container">
        <button id="start-analysis-btn" class="btn btn-primary">Start Duplication Analysis</button>
    </div>

    <div id="contract-cards-container" class="contract-cards">
        <div class="loading-placeholder">
            Click "Start Duplication Analysis" to begin finding potential duplicates.
        </div>
    </div>

    <div class="contracts-status-section">
        <!-- Status legend -->
        <div class="contract-legend">
            <div class="legend-item">
                <div class="color-box included-color"></div>
                <span>Included Contracts</span>
            </div>
            <div class="legend-item">
                <div class="color-box excluded-color"></div>
                <span>Excluded Contracts</span>
            </div>
            <div class="search-wrapper">
                <select id="search-type" class="search-type-select">
                    <option value="contains">Contains</option>
                    <option value="not-contains">Not Contains</option>
                </select>
                <input type="text" id="contract-search" class="search-input" placeholder="Filter results...">
                <button type="button" id="contract-clear-search-btn" class="clear-search-btn" title="Clear search">Clear</button>
            </div>
        </div>
        
        <!-- Included contracts tags -->
        <div class="included-contracts">
            <div class="tags-label">Included Contracts:</div>
            <div id="included-contracts-tags" class="tags-container">
                <!-- Tags will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Spinner overlay for Step 2.1 (Duplication Analysis) -->
    <div id="loading-overlay-spinner" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    
    <div class="review-actions" style="margin-top: 20px; text-align: right; display: none;">
        <button id="continue-btn" class="btn btn-success">Contract Level Review Complete</button>
    </div>
    
    <!-- Item Detail Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Contract Items</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="modal-body">
                <div id="contract-info">
                    <p><strong>Contract Number:</strong> <span id="modal-contract-number"></span></p>
                    <p><strong>Description:</strong> <span id="modal-contract-description"></span></p>
                    <p><strong>Owner:</strong> <span id="modal-contract-owner"></span></p>
                </div>
                <div class="table-responsive-container">
                    <table id="items-table-modal" class="modal-table">
                        <thead>
                            <tr>
                                <th>CCX Mfg Part #</th>
                                <th>Upload Mfg Part #</th>
                                <th>MFN Match</th>
                                <th>CCX UOM</th>
                                <th>Upload UOM</th>
                                <th>CCX Price</th>
                                <th>Upload Price</th>
                                <th>CCX Description</th>
                                <th>Upload Description</th>
                                <th>Contract Number</th>
                                <th>Manufacturer (CCX)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress overlay for Step 2.2 (Item-Level Comparison) -->
    <div id="loading-overlay-progress" class="loading-overlay" style="display: none;">
        <div class="progress-overlay-content">
            <h5 class="progress-title">Processing Item Comparisons</h5>
            <div class="progress-container">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progress-percentage" class="text-center mt-2">0%</div>
            </div>
            <p id="progress-message" class="text-center mt-3">Starting comparison...</p>
            <p id="items-processed" class="text-center text-muted small">Processed: 0 of 0 items</p>
        </div>
    </div>

    <!-- Item Level Comparison Section - Initially Hidden -->
    <div id="item-comparison-container" class="item-comparison-container">
        <h3>Step 2.2: Item-Level Comparison</h3>
        <p>Review detailed item-level comparisons for the contracts you've included. Items are grouped by confidence level based on multiple matching criteria.</p>
        
        <div id="comparison-results-container" style="display:none;">
            <div class="confidence-cards">
                <div id="high-confidence-card" class="confidence-card high" data-level="high">
                    <div class="confidence-title">High Confidence</div>
                    <div class="count-number" id="high-count">0</div>
                    <div class="count-label">Items</div>
                    <div class="false-positive-count" id="high-false-positive-count">0 marked as false positive</div>
                </div>
                
                <div id="medium-confidence-card" class="confidence-card medium" data-level="medium">
                    <div class="confidence-title">Medium Confidence</div>
                    <div class="count-number" id="medium-count">0</div>
                    <div class="count-label">Items</div>
                    <div class="false-positive-count" id="medium-false-positive-count">0 marked as false positive</div>
                </div>
                
                <div id="low-confidence-card" class="confidence-card low" data-level="low">
                    <div class="confidence-title">Low Confidence</div>
                    <div class="count-number" id="low-count">0</div>
                    <div class="count-label">Items</div>
                    <div class="false-positive-count" id="low-false-positive-count">0 marked as false positive</div>
                </div>
            </div>
            
            <div id="items-detail-view" style="display:none;">
                <h4 id="detail-title">High Confidence Matches</h4>
                
                <div class="controls-container">
                    <div class="filter-container">
                        <div class="search-wrapper">
                            <select id="item-search-type" class="search-type-select">
                                <option value="contains">Contains</option>
                                <option value="not-contains">Not Contains</option>
                            </select>
                            <input type="text" id="item-search" class="search-input" placeholder="Filter items...">
                            <button type="button" id="clear-search-btn" class="clear-search-btn" title="Clear search">Clear</button>
                        </div>
                    </div>
                    
                    
                    <div class="batch-controls">
                        <button id="select-all-btn" class="btn btn-sm btn-secondary">Select All</button>
                        <button id="deselect-all-btn" class="btn btn-sm btn-secondary">Deselect All</button>
                        <button id="save-selections-btn" class="btn btn-sm btn-primary">Save Selections</button>
                    </div>
                </div>
                
                <div class="items-table-container">
                    <table id="items-table" class="items-table">
                        <thead>
                            <tr>
                                <th data-sort="mfg_part_num_ccx">Mfg Part Num (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="Mfg_Part_Num">Mfg Part Num (Upload)<span class="sort-indicator"></span></th>
                                <th data-sort="uom_ccx">UOM (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="UOM">UOM (Upload)<span class="sort-indicator"></span></th>
                                <th data-sort="qoe_ccx">QOE (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="QOE">QOE (Upload)<span class="sort-indicator"></span></th>
                                <th data-sort="ccx_ea_price">EA Price (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="upload_ea_price">EA Price (Upload)<span class="sort-indicator"></span></th>
                                <th data-sort="same_mfg_part_num">Exact MFN Match<span class="sort-indicator"></span></th>
                                <th data-sort="weighted_score">Confidence<span class="sort-indicator"></span></th>
                                <th>False Positive</th>
                                <th data-sort="description_ccx">Description (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="Description">Description (Upload)<span class="sort-indicator"></span></th>
                                <th data-sort="contract_number_ccx">Contract Number (CCX)<span class="sort-indicator"></span></th>
                                <th data-sort="manufacturer_name_ccx">Manufacturer (CCX)<span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-matches-message" class="no-matches" style="display:none;">
                    <h4>No items found in this confidence level</h4>
                    <p>Please select a different confidence level or adjust your filters.</p>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px; text-align: right;">
                <form method="POST" action="{{ url_for('common.process_step', step_id=2) }}">
                    <input type="hidden" name="step_completed" value="true">
                    <button type="submit" class="btn btn-success">Complete Step 2</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Action buttons
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const saveSelectionsBtn = document.getElementById('save-selections-btn');

    // Contract-Level Duplication Review Elements
    const loadingOverlaySpinner = document.getElementById('loading-overlay-spinner');
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    const contractCardsContainer = document.getElementById('contract-cards-container');
    const contractClearSearchBtn = document.getElementById('contract-clear-search-btn');
    const continueBtn = document.getElementById('continue-btn');
    const contractSearch = document.getElementById('contract-search');
    const searchTypeSelect = document.getElementById('search-type');
    const modal = document.getElementById('item-modal');
    const closeBtn = modal.querySelector('.close-btn');

    // this is the top level item comparison container
    const itemComparisonContainer = document.getElementById('item-comparison-container');
    // this is the container for the confidence cards
    const comparisonResultsContainer = document.getElementById('comparison-results-container');
    // Item-Level Comparison Code
    const clearSearchBtn = document.getElementById('clear-search-btn');
    const itemSearchInput = document.getElementById('item-search');
    const itemSearchType = document.getElementById('item-search-type');
    const itemsDetailView = document.getElementById('items-detail-view');
    const detailTitle = document.getElementById('detail-title');
    const itemsTable = document.getElementById('items-table');
    const itemsTbody = document.getElementById('items-tbody');
    const noMatchesMessage = document.getElementById('no-matches-message');

    // Progress bar elements
    const loadingOverlayProgress = document.getElementById('loading-overlay-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    const itemsProcessed = document.getElementById('items-processed');

    
    // Track included/excluded contracts
    let includedContracts = [];
    let excludedContracts = [];
    let allContracts = [];
    
    // 2.2 Item-Level Comparison Variables
    let currentItems = [];
    let currentLevel = null;
    let sortField = null;
    let sortDirection = 'asc';

    
    startAnalysisBtn.addEventListener('click', function() {
        // Show loading overlay
        loadingOverlaySpinner.style.display = 'flex';
        
        // Start the duplication analysis
        fetch('/duplicate-detection/process-duplicates', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlaySpinner.style.display = 'none';
            
            if (data.success) {
                // Store contracts
                allContracts = data.contracts;
                
                // Display contracts
                displayContracts(allContracts);
                
                // Show review actions
                document.querySelector('.review-actions').style.display = 'block';
                document.querySelector('.contracts-status-section').style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlaySpinner.style.display = 'none';
            alert('Error: ' + error);
        });
    });

    
    contractClearSearchBtn.addEventListener('click', function() {
        // Clear the search input
        contractSearch.value = '';
        // Reset search type to "contains"
        searchTypeSelect.value = 'contains';
        // Trigger filtering to show all contracts
        filterContracts();
    });

    function initializeIncludedContracts() {
        console.log("Saving included contracts:", includedContracts);
        
        // Send included contracts to the server
        fetch('/duplicate-detection/initialize-included-contracts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_numbers: includedContracts
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Successfully saved included contracts:", data);
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
            } else {
                console.error("Error saving included contracts");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }

    
    function displayContracts(contracts) {
        contractCardsContainer.innerHTML = '';
        
        if (contracts.length === 0) {
            contractCardsContainer.innerHTML = `
                <div class="no-results">
                    <h4>No matching contracts found on CCX</h4>
                    <p>Mostly there is no duplication for your uploaded items on CCX, we can skip step2 and 3.</p>
                </div>
            `;
            return;
        }
        
        // Automatically include all contracts by default if not explicitly excluded
        contracts.forEach(contract => {
            if (!excludedContracts.includes(contract.contract_number) && 
                !includedContracts.includes(contract.contract_number)) {
                includedContracts.push(contract.contract_number);
            }
        });
        
        // Sync the included contracts with the server
        fetch('/duplicate-detection/initialize-included-contracts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_numbers: includedContracts
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update local variables with server data
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
            } else {
                console.error('Error initializing contracts:', data.message);
            }
        })
        .catch(error => {
            console.error('Error initializing contracts:', error);
        });
        
        // Update included contracts tags display
        updateIncludedContractsTags();
        
        contracts.forEach(contract => {
            const isExcluded = excludedContracts.includes(contract.contract_number);
            
            const card = document.createElement('div');
            card.className = `contract-card ${isExcluded ? 'excluded' : 'selected'}`;
            card.dataset.contractNumber = contract.contract_number;
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <h4 class="card-title">${contract.contract_number}</h4>
                        <div class="card-subtitle">${contract.contract_description || 'No description'}</div>
                        <div class="card-subtitle">Manufacturer: <strong>${contract.manufacturer_name || 'Unknown'}</strong></div>
                    </div>
                    <div class="status-indicator">
                        <span class="status-text ${isExcluded ? 'status-excluded' : 'status-included'}">
                            ${isExcluded ? 'Excluded' : 'Included'}
                        </span>
                        <button type="button" class="toggle-action-btn" data-contract="${contract.contract_number}">
                            ${isExcluded ? 'Include' : 'Exclude'}
                        </button>
                    </div>
                </div>
                <div class="card-stats">
                    <div class="card-stat">
                        <div class="stat-value">${contract.total_matches}</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="card-stat">
                        <div class="stat-value">${contract.exact_matches}</div>
                        <div class="stat-label">Exact MFN Matches</div>
                    </div>
                    <div class="card-stat">
                        <div class="stat-value">${contract.total_line_count_ccx || 'N/A'}</div>
                        <div class="stat-label">Total CCX Lines</div>
                    </div>
                </div>
            `;
            
            contractCardsContainer.appendChild(card);
        });
        
        // Add click event to card for details view
        document.querySelectorAll('.contract-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Ignore clicks on the toggle button
                if (e.target.classList.contains('toggle-action-btn') || 
                    e.target.closest('.toggle-action-btn')) {
                    return;
                }
                
                // Show contract details
                showContractDetails(this.dataset.contractNumber);
            });
        });
        
        // Add click event to toggle buttons - fixed to use proper selector
        document.querySelectorAll('.toggle-action-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent opening the modal
                
                const contractNum = this.dataset.contract;
                const isExcluded = excludedContracts.includes(contractNum);
                
                // Toggle inclusion state
                toggleContractInclusion(contractNum, isExcluded);
            });
        });
    }

    // Add this new function to update the tags display
    function updateIncludedContractsTags() {
        const tagsContainer = document.getElementById('included-contracts-tags');
        if (!tagsContainer) return;
        
        tagsContainer.innerHTML = '';
        
        if (includedContracts.length === 0) {
            tagsContainer.innerHTML = '<span class="empty-tag">No contracts included</span>';
            return;
        }
        
        includedContracts.forEach(contractNum => {
            const tag = document.createElement('span');
            tag.className = 'contract-tag';
            tag.textContent = contractNum;
            tagsContainer.appendChild(tag);
        });
    }

    // Update the toggle function to refresh the tags
    function toggleContractInclusion(contractNum, currentlyExcluded) {
        // Show loading overlay
        loadingOverlaySpinner.style.display = 'flex';
        
        // Send request to update inclusion status
        fetch('/duplicate-detection/include-exclude-contract', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_num: contractNum,
                include: currentlyExcluded // If currently excluded, we want to include it
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlaySpinner.style.display = 'none';
            
            if (data.success) {
                // Update local arrays
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
                
                // Update the UI
                const card = document.querySelector(`.contract-card[data-contract-number="${contractNum}"]`);
                if (card) {
                    const isExcluded = excludedContracts.includes(contractNum);
                    
                    // Update card class
                    card.className = `contract-card ${isExcluded ? 'excluded' : 'selected'}`;
                    
                    // Update status text
                    const statusText = card.querySelector('.status-text');
                    statusText.className = `status-text ${isExcluded ? 'status-excluded' : 'status-included'}`;
                    statusText.textContent = isExcluded ? 'Excluded' : 'Included';
                    
                    // Update toggle button text
                    const toggleBtn = card.querySelector('.toggle-action-btn');
                    toggleBtn.textContent = isExcluded ? 'Include' : 'Exclude';
                }
                
                // Update included contracts tags
                updateIncludedContractsTags();
            }
        })
        .catch(error => {
            loadingOverlaySpinner.style.display = 'none';
            console.error('Error toggling contract inclusion:', error);
        });
    }

    
    // Filter contracts when searching
    contractSearch.addEventListener('input', function() {
        filterContracts();
    });

    // Also filter when search type changes
    searchTypeSelect.addEventListener('change', function() {
        filterContracts();
    });

    function filterContracts() {
        const searchTerm = contractSearch.value.toLowerCase();
        const searchType = searchTypeSelect.value;
        
        if (!allContracts.length) return;
        
        // Filter contracts by search term and type
        const filteredContracts = allContracts.filter(contract => {
            // Check if contract info contains search term
            const contractInfo = [
                contract.contract_number,
                contract.contract_description || '',
                contract.manufacturer_name || ''
            ].join(' ').toLowerCase();
            
            // Apply filter based on search type
            if (searchType === 'contains') {
                return contractInfo.includes(searchTerm);
            } else {
                // 'not-contains'
                return !contractInfo.includes(searchTerm);
            }
        });
        
        displayContracts(filteredContracts);
    }
    
    function toggleContractInclusion(contractNum, currentlyExcluded) {
        // Show loading
        loadingOverlaySpinner.style.display = 'flex';
        
        fetch('/duplicate-detection/include-exclude-contract', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_num: contractNum,
                include: currentlyExcluded // If currently excluded, include it now
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlaySpinner.style.display = 'none';
            
            if (data.success) {
                // Update local tracking
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
                
                // Refresh display
                displayContracts(allContracts);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlaySpinner.style.display = 'none';
            alert('Error: ' + error);
        });
    }
    
    function showContractDetails(contractNum) {
        // Show loading
        loadingOverlaySpinner.style.display = 'flex';
        
        fetch(`/duplicate-detection/get-duplicate-items/${contractNum}`)
        .then(response => response.json())
        .then(data => {
            loadingOverlaySpinner.style.display = 'none';
            
            if (data.success) {
                const contract = data.contract;
                
                // Populate modal with contract info
                document.getElementById('modal-contract-number').textContent = contract.contract_number;
                document.getElementById('modal-contract-description').textContent = contract.contract_description || 'N/A';
                document.getElementById('modal-contract-owner').textContent = contract.contract_owner || 'N/A';
                
                // Populate items table
                const itemsTable = document.getElementById('items-table-modal').querySelector('tbody');
                itemsTable.innerHTML = '';
                
                contract.items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Is exact match
                    const isExactMatch = item.same_mfg_part_num === 1;
                    
                    // Add title attribute to show full text on hover for descriptions
                    const ccxDescription = item.description_ccx || 'N/A';
                    const uploadDescription = item.Description || 'N/A';
                    
                    row.innerHTML = `
                        <td>${item.mfg_part_num_ccx || 'N/A'}</td>
                        <td>${item.Mfg_Part_Num || 'N/A'}</td>
                        <td>
                            <span class="match-indicator ${isExactMatch ? 'match' : 'mismatch'}">
                                ${isExactMatch ? 'Exact Match' : 'Partial Match'}
                            </span>
                        </td>
                        <td>${item.uom_ccx || 'N/A'}</td>
                        <td>${item.UOM || 'N/A'}</td>
                        <td>$${parseFloat(item.price_ccx).toFixed(2) || 'N/A'}</td>
                        <td>$${parseFloat(item.Contract_Price).toFixed(2) || 'N/A'}</td>
                        <td title="${ccxDescription}">${ccxDescription}</td>
                        <td title="${uploadDescription}">${uploadDescription}</td>
                        <td>${item.contract_number_ccx || 'N/A'}</td>
                        <td>${item.manufacturer_name_ccx || 'N/A'}</td>
                    `;
                    
                    itemsTable.appendChild(row);
                });
                
                // Show modal
                modal.style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlaySpinner.style.display = 'none';
            alert('Error: ' + error);
        });
    }
    
    // Close modal when clicking on X button
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // this triggers the item level comparison
    // we have SSE call here to get the progress of the item level comparison
    continueBtn.addEventListener('click', function() {
        if (includedContracts.length === 0) {
            alert('Please include at least one contract before proceeding.');
            return;
        }
        
        // Show the item-level comparison section
        const itemComparisonContainer = document.getElementById('item-comparison-container');
        if (itemComparisonContainer) {
            itemComparisonContainer.style.display = 'block';
            
            // Scroll to the item comparison section
            itemComparisonContainer.scrollIntoView({
                behavior: 'smooth'
            });
        }

        
        // Show loading overlay with progress bar instead of spinner
        if (loadingOverlayProgress) {
            loadingOverlayProgress.style.display = 'flex';
            
            // Reset progress indicators
            if (progressBar) progressBar.style.width = '0%';
            if (progressPercentage) progressPercentage.textContent = '0%';
            if (progressMessage) progressMessage.textContent = 'Starting comparison...';
            if (itemsProcessed) itemsProcessed.textContent = 'Processed: 0 of 0 items';
        }
        
        // Set up Server-Sent Events for progress updates
        const eventSource = new EventSource('/duplicate-detection/process-item-comparison-with-progress');
        
        eventSource.onmessage = function(event) {
            try {
                console.log("Raw event data:", event.data);
                const data = JSON.parse(event.data);
                console.log("Parsed progress data:", data);
                
                // Update progress indicators
                progressBar.style.width = data.progress + '%';
                progressPercentage.textContent = data.progress + '%';
                progressMessage.textContent = data.message;
                itemsProcessed.textContent = `Processed: ${data.processed} of ${data.total} items`;
                
                // Check if processing is complete
                if (data.status === 'done') {
                    console.log("Processing complete!");
                    eventSource.close();
                    
                    // Call finalize endpoint to ensure session data is saved
                    fetch('/duplicate-detection/finalize-item-comparison', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log("Results finalized successfully");                           
                            // Wait a moment before hiding the overlay
                            setTimeout(() => {
                                loadingOverlayProgress.style.display = 'none';                                
                                // Fetch and display summary AFTER finalizing
                                fetchItemComparisonSummary();
                            }, 1000);
                        } else {
                            console.error("Error finalizing results:", data.message);
                            // retry logic for resilience
                            setTimeout(() => {
                                console.log("Retrying to finalize results...");
                                fetch('/duplicate-detection/finalize-item-comparison', {
                                    method: 'POST'
                                })
                                .then(response => response.json())
                                .then(retryData => {
                                    if (retryData.success) {
                                        console.log("Results finalized successfully on retry");
                                        loadingOverlayProgress.style.display = 'none';
                                        fetchItemComparisonSummary();
                                    } else {
                                        console.error("Retry Failed:", retryData.message);
                                        alert("Error finalizing results on retry. Please try again.");
                                        loadingOverlayProgress.style.display = 'none';
                                    }
                                })
                                .catch(retryError => {
                                    console.error("Retry Error:", retryError);
                                    alert("Error finalizing results on retry. Please try again.");
                                    loadingOverlayProgress.style.display = 'none';
                                });
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error("Error finalizing results bbb:", error);
                        alert("Error finalizing results. Please try again.");
                        loadingOverlayProgress.style.display = 'none';
                    });
                }
            } catch (error) {
                console.error("Error processing SSE message:", error);
            }
        };
        
        eventSource.onerror = function() {
            eventSource.close();
            progressMessage.textContent = 'Error processing items x. Please try again.';
            setTimeout(() => {
                loadingOverlayProgress.style.display = 'none';
            }, 3000);
        };
    });

    // Add a new function to make initialization synchronous with callback
    function initializeIncludedContractsWithCallback(callback) {
        console.log("Saving included contracts with callback:", includedContracts);
        
        // Send included contracts to the server
        fetch('/duplicate-detection/initialize-included-contracts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_numbers: includedContracts
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Successfully saved included contracts:", data);
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
                
                // Execute callback after successful initialization
                if (typeof callback === 'function') {
                    callback();
                }
            } else {
                console.error("Error saving included contracts:", data.message);
                alert("Error initializing contracts. Please try again.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Error initializing contracts. Please try again.");
        });
    }

    function fetchItemComparisonSummary() {
        console.log("Fetching comparison summary...");
        
        // Check if comparison container exists before proceeding
        if (!comparisonResultsContainer) {
            console.error("comparison-results-container element not found in the DOM");
            alert("UI Error: Could not find results container. Please refresh the page and try again.");
            return;
        }
        
        fetch('/duplicate-detection/get-item-comparison-summary')
            .then(response => {
                // Check if response is ok before parsing JSON
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Got summary data:", data);
                
                if (data.success) {
                    // Make container visible first
                    comparisonResultsContainer.style.display = 'block';
                    
                    // Debug summary data
                    console.log("Summary data structure:", JSON.stringify(data.summary));
                    
                    // Explicitly check if summary data is actually populated
                    if (!data.summary || Object.keys(data.summary).length === 0) {
                        console.error("Summary data is empty or missing");
                        alert("No item comparison data was retrieved. Please try again.");
                        return;
                    }
                    
                    // Update summary counts
                    updateSummaryCounts(data.summary);
                    
                    // Make items detail view visible
                    itemsDetailView.style.display = 'block';
                    
                    // Load appropriate confidence level items
                    if (data.summary.high && data.summary.high.total > 0) {
                        console.log("Loading high confidence items...");
                        loadConfidenceItems('high');
                    } else if (data.summary.medium && data.summary.medium.total > 0) {
                        console.log("Loading medium confidence items...");
                        loadConfidenceItems('medium');
                    } else if (data.summary.low && data.summary.low.total > 0) {
console.log("Loading low confidence items...");
                        loadConfidenceItems('low');
                    } else {
                        console.warn("No items found in any confidence level");
                        noMatchesMessage.style.display = 'block';
                        document.querySelector('.items-table-container').style.display = 'none';
                    }
                } else {
                    console.error("Error in summary data:", data.message);
                    alert("Error loading comparison results: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error fetching summary:", error);
                // Show more informative error message for users
                alert("Error loading comparison results. Please check the console for details and try again.");
                // Hide the progress overlay
                loadingOverlayProgress.style.display = 'none';
            });
    }

    // Confidence card click handlers
    document.querySelectorAll('.confidence-card').forEach(card => {
        card.addEventListener('click', function() {
            const level = this.dataset.level;
            loadConfidenceItems(level);
        });
    });
    
    // Table header click for sorting
    document.querySelectorAll('.items-table th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
            const field = this.dataset.sort;
            
            // Toggle direction if same field, otherwise default to asc
            if (field === sortField) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.items-table th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            this.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Re-render the table with new sort
            renderItemsTable(currentItems);
        });
    });
    
    // Filter input handler
    // Add event listeners for filtering
    itemSearchInput.addEventListener('input', filterItemTable);
    itemSearchType.addEventListener('change', filterItemTable);

    function filterItemTable() {
        const searchTerm = itemSearchInput.value.toLowerCase();
        const searchType = itemSearchType.value;
        const tableRows = document.querySelectorAll('#items-tbody tr');
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchesContains = text.includes(searchTerm);
            
            // Show/hide based on search type
            if (searchType === 'contains') {
                row.style.display = matchesContains ? '' : 'none';
            } else { // not-contains
                row.style.display = matchesContains ? 'none' : '';
            }
        });
        
        // Update visible count
        updateVisibleItemCount();
    }

    clearSearchBtn.addEventListener('click', function() {
        // Clear the search input
        itemSearchInput.value = '';
        // Reset search type to "contains"
        itemSearchType.value = 'contains';
        // Trigger filtering to show all items
        filterItemTable();
    });

    function updateVisibleItemCount() {
        const visibleRows = document.querySelectorAll('#items-tbody tr[style="display: none;"]').length;
        const totalRows = document.querySelectorAll('#items-tbody tr').length;
        const visibleCount = totalRows - visibleRows;
        
        // If you have an element to display the count, update it here
        const countElement = document.getElementById('visible-item-count');
        if (countElement) {
            countElement.textContent = `Showing ${visibleCount} of ${totalRows} items`;
        }
    }
    
    // Select/Deselect all buttons
    selectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('#items-tbody input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('#items-tbody input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    
    // Save selections button
    saveSelectionsBtn.addEventListener('click', function() {
        saveSelections();
    });
    
    // Function to update summary counts
    function updateSummaryCounts(summary) {
        document.getElementById('high-count').textContent = summary.high.total;
        document.getElementById('medium-count').textContent = summary.medium.total;
        document.getElementById('low-count').textContent = summary.low.total;
        
        document.getElementById('high-false-positive-count').textContent = 
            summary.high.false_positives + ' marked as false positive';
        document.getElementById('medium-false-positive-count').textContent = 
            summary.medium.false_positives + ' marked as false positive';
        document.getElementById('low-false-positive-count').textContent = 
            summary.low.false_positives + ' marked as false positive';
    }
    
    // Function to load items for a confidence level
    function loadConfidenceItems(level) {
        // Update selected card
        document.querySelectorAll('.confidence-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.getElementById(level + '-confidence-card').classList.add('selected');
        
        // Update level title
        detailTitle.textContent = level.charAt(0).toUpperCase() + level.slice(1) + ' Confidence Matches';
        
        loadingOverlaySpinner.style.display = 'flex';
        currentLevel = level;
        
        console.log(`Fetching items for confidence level: ${level}`);
        
        fetch(`/duplicate-detection/get-comparison-items/${level}`)
            .then(response => response.json())
            .then(data => {
                loadingOverlaySpinner.style.display = 'none';
                
                if (data.success) {
                    console.log(`Received ${data.count} items for ${level} level`);
                    
                    // Store current items
                    currentItems = data.items;
                    
                    // Reset sorting and filtering
                    sortField = null;
                    sortDirection = 'asc';
                    document.querySelectorAll('.items-table th').forEach(header => {
                        header.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    // Render items
                    renderItemsTable(currentItems);
                    
                    // Show the detail view - this should already be visible from fetchItemComparisonSummary
                    // but ensure it's still visible
                    itemsDetailView.style.display = 'block';
                    
                    // Show/hide no matches message
                    noMatchesMessage.style.display = currentItems.length === 0 ? 'block' : 'none';
                    document.querySelector('.items-table-container').style.display = 
                        currentItems.length === 0 ? 'none' : 'block';

                    // Reapply filter after rendering
                    filterItemTable();
                } else {
                    console.error(`Error fetching ${level} items:`, data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                loadingOverlaySpinner.style.display = 'none';
                console.error(`Error in fetch for ${level} items:`, error);
                alert('Error: ' + error);
            });
    }
    
    // Function to render the items table
    function renderItemsTable(items) {
        // Clear the table
        itemsTbody.innerHTML = '';
        
        // Sort items if sort field is set
        if (sortField) {
            items = [...items].sort((a, b) => {
                let valA = a[sortField];
                let valB = b[sortField];
                
                // Handle numeric fields
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                
                // Handle string fields
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        // Add rows to table
        items.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // Get confidence class based on score
            const scoreClass = item.weighted_score >= 0.8 ? 'high-score' : 
                              (item.weighted_score >= 0.6 ? 'medium-score' : 'low-score');
            
            // Format EA prices
            const ccxEaPrice = item.ccx_ea_price !== null ? 
                '$' + parseFloat(item.ccx_ea_price).toFixed(2) : 'N/A';
            const uploadEaPrice = item.upload_ea_price !== null ? 
                '$' + parseFloat(item.upload_ea_price).toFixed(2) : 'N/A';
            
            row.innerHTML = `
                <td>${item.mfg_part_num_ccx || 'N/A'}</td>
                <td>${item.Mfg_Part_Num || 'N/A'}</td>
                <td>${item.uom_ccx || 'N/A'}</td>
                <td>${item.UOM || 'N/A'}</td>
                <td>${item.qoe_ccx || 'N/A'}</td>
                <td>${item.QOE || 'N/A'}</td>
                <td>${ccxEaPrice}</td>
                <td>${uploadEaPrice}</td>
                <td>
                    <div class="match-indicator ${item.same_mfg_part_num === 1 ? 'match' : 'no-match'}"></div>
                </td>
                <td class="score-cell ${scoreClass}">${Math.round(item.weighted_score * 100)}%</td>
                <td>
                    <input type="checkbox" class="false-positive-checkbox" 
                        data-index="${index}" 
                        ${item.false_positive ? 'checked' : ''}>
                </td>
                <td title="${item.description_ccx || 'N/A'}">${(item.description_ccx || 'N/A').substring(0, 50)}${(item.description_ccx && item.description_ccx.length > 50) ? '...' : ''}</td>
                <td title="${item.Description || 'N/A'}">${(item.Description || 'N/A').substring(0, 50)}${(item.Description && item.Description.length > 50) ? '...' : ''}</td>
                <td>${item.contract_number_ccx || 'N/A'}</td>
                <td>${item.manufacturer_name_ccx || 'N/A'}</td>
            `;
            
            itemsTbody.appendChild(row);
        });
    }
    
    
    // Function to save false positive selections
    function saveSelections() {
        // Show loading overlay
        loadingOverlaySpinner.style.display = 'flex';
        
        // Get all checkboxes and their status
        const checkboxes = document.querySelectorAll('#items-tbody input[type="checkbox"]');
        
        // Create a map of all items and their status
        const itemUpdates = Array.from(checkboxes).map(checkbox => {
            return {
                index: parseInt(checkbox.dataset.index),
                is_false_positive: checkbox.checked
            };
        });
        
        // Send a single request with complete state
        fetch('/duplicate-detection/update-false-positives', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confidence_level: currentLevel,
                item_updates: itemUpdates
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlaySpinner.style.display = 'none';
            
            if (data.success) {
                // Update the item states in the local array
                itemUpdates.forEach(update => {
                    if (update.index < currentItems.length) {
                        currentItems[update.index].false_positive = update.is_false_positive;
                    }
                });
                
                // Update the summary display
                updateSummaryCounts(data.summary);
                
                // Show success message
                alert('Selections saved successfully');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlaySpinner.style.display = 'none';
            alert('Error saving selections: ' + error.message);
        });
    }
});
</script>
