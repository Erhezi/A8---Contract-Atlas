<!-- Duplication Overview Content -->
<style>
    .contract-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Always 2 columns of equal width */
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .contract-card {
    /* No flex properties needed with grid */
    background-color: #fff;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 5px solid #2ecc71;
    transition: all 0.3s ease;
    cursor: pointer;
    }
    
    .contract-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .contract-card.selected {
        border-left-color: #2ecc71;
    }
    
    .contract-card.excluded {
        border-left-color: #e74c3c;
        opacity: 0.7;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .card-title {
        margin: 0 0 10px 0; /* give bottom 10px margin */
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: bold;
    }
    
    .card-subtitle {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin: 8px 0;
        line-height: 1.4;
    }

    .card-subtitle.manufacturer {
        margin-top: 5px; /* Extra space above manufacturer */
        padding-top: 8px; /* Add padding */
        border-top: 1px dotted #eee; /* Optional: subtle separator */
    }
    
    .card-stats {
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #ecf0f1;
        padding-top: 10px;
        margin-top: 10px;
    }
    
    .card-stat {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #3498db;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #7f8c8d;
    }
    

    .toggle-action-btn {
        font-size: 0.75rem;
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 5px;
        font-weight: 500;
    }
    
    .toggle-action-btn:hover {
        background-color: #e0e0e0;
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.3rem;
    }
    
    .close-btn {
        font-size: 1.5rem;
        cursor: pointer;
        border: none;
        background: none;
    }
    
    .modal-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .modal-table th, .modal-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .modal-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .modal-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .modal-table tr:hover {
        background-color: #e6f7ff;
    }
    
    .match-indicator {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .match-indicator.match {
        background-color: #d4edda;
        color: #155724;
    }
    
    .match-indicator.mismatch {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    .search-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 300px;
        margin-right: 10px;
    }

    .no-results {
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }


    .contracts-status-section {
        margin: 15px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
    }

    .contract-legend {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .color-box {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }

    .included-color {
        background-color: #2ecc71;
    }
    
    .excluded-color {
        background-color: #e74c3c;
    }
    
    .included-contracts {
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .tags-label {
        font-weight: bold;
        margin-top: 5px;
    }
    
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .contract-tag {
        background-color: #e1f5fe;
        color: #0277bd;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        border: 1px solid #b3e5fc;
        white-space: nowrap;
    }
    
    .empty-tag {
        color: #999;
        font-style: italic;
    }

    .status-text {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: inline-block;
        text-align: center;
        min-width: 90px;
    }
    
    .status-included {
        background-color: #28a745;
        color: white;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .status-excluded {
        background-color: #dc3545;
        color: white;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .contract-card.selected .toggle-action-btn {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .contract-card.selected .toggle-action-btn:hover {
        background-color: #e74c3c;
        color: white;
    }
    
    .contract-card.excluded .toggle-action-btn {
        background-color: #d4edda;
        color: #155724;
    }
    
    .contract-card.excluded .toggle-action-btn:hover {
        background-color: #28a745;
        color: white;
    }
    
    /* Improve indicator alignment */
    .status-indicator {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
    }

    .contract-filter-container {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .search-wrapper {
        display: flex;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .search-type-select {
        padding: 8px;
        border: none;
        border-right: 1px solid #ddd;
        background-color: #f5f5f5;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .search-input {
        padding: 8px 12px;
        border: none;
        width: 300px;
    }

</style>

<div class="step-content">
    <h3>Step 2.1: Contract-Level Duplication Review</h3>
    <p>Review potential duplicate items between your upload and the CCX database. First, review at the contract level to identify which contracts might have matching items.</p>
    
    <div class="contract-filter-container">
        <button id="start-analysis-btn" class="btn btn-primary">Start Duplication Analysis</button>
    </div>

    <div class="contracts-status-section">
        <!-- Status legend -->
        <div class="contract-legend">
            <div class="legend-item">
                <div class="color-box included-color"></div>
                <span>Included Contracts</span>
            </div>
            <div class="legend-item">
                <div class="color-box excluded-color"></div>
                <span>Excluded Contracts</span>
            </div>
            <div class="search-wrapper">
                <select id="search-type" class="search-type-select">
                    <option value="contains">Contains</option>
                    <option value="not-contains">Not Contains</option>
                </select>
                <input type="text" id="contract-search" class="search-input" placeholder="Filter results...">
            </div>
        </div>
        
        <!-- Included contracts tags -->
        <div class="included-contracts">
            <div class="tags-label">Included Contracts:</div>
            <div id="included-contracts-tags" class="tags-container">
                <!-- Tags will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="contract-cards-container" class="contract-cards">
        <div class="loading-placeholder">
            Click "Start Duplication Analysis" to begin finding potential duplicates.
        </div>
    </div>
    
    <div class="review-actions" style="margin-top: 20px; text-align: right; display: none;">
        <button id="continue-btn" class="btn btn-success">Contract Level Review Complete</button>
    </div>
    
    <!-- Item Detail Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Contract Items</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="modal-body">
                <div id="contract-info">
                    <p><strong>Contract Number:</strong> <span id="modal-contract-number"></span></p>
                    <p><strong>Description:</strong> <span id="modal-contract-description"></span></p>
                    <p><strong>Owner:</strong> <span id="modal-contract-owner"></span></p>
                </div>
                <div class="table-responsive-container">
                    <table id="items-table" class="modal-table">
                        <thead>
                            <tr>
                                <th>CCX Mfg Part #</th>
                                <th>Upload Mfg Part #</th>
                                <th>MFN Match</th>
                                <th>CCX UOM</th>
                                <th>Upload UOM</th>
                                <th>CCX Price</th>
                                <th>Upload Price</th>
                                <th>CCX Description</th>
                                <th>Upload Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contractCardsContainer = document.getElementById('contract-cards-container');
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    const continueBtn = document.getElementById('continue-btn');
    const contractSearch = document.getElementById('contract-search');
    const searchTypeSelect = document.getElementById('search-type');
    const modal = document.getElementById('item-modal');
    const closeBtn = modal.querySelector('.close-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Track included/excluded contracts
    let includedContracts = [];
    let excludedContracts = [];
    let allContracts = [];
    
    startAnalysisBtn.addEventListener('click', function() {
        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        
        // Start the duplication analysis
        fetch('/process-duplicates', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // Store contracts
                allContracts = data.contracts;
                
                // Display contracts
                displayContracts(allContracts);
                
                // Show review actions
                document.querySelector('.review-actions').style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            alert('Error: ' + error);
        });
    });
    
    function displayContracts(contracts) {
        contractCardsContainer.innerHTML = '';
        
        if (contracts.length === 0) {
            contractCardsContainer.innerHTML = `
                <div class="no-results">
                    <h4>No matching contracts found on CCX</h4>
                    <p>Mostly there is no duplication for your uploaded items on CCX, we can skip step2 and 3.</p>
                </div>
            `;
            return;
        }
        
        // Automatically include all contracts by default if not explicitly excluded
        contracts.forEach(contract => {
            if (!excludedContracts.includes(contract.contract_number) && 
                !includedContracts.includes(contract.contract_number)) {
                includedContracts.push(contract.contract_number);
            }
        });
        
        // Update included contracts tags display
        updateIncludedContractsTags();
        
        contracts.forEach(contract => {
            const isExcluded = excludedContracts.includes(contract.contract_number);
            
            const card = document.createElement('div');
            card.className = `contract-card ${isExcluded ? 'excluded' : 'selected'}`;
            card.dataset.contractNumber = contract.contract_number;
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <h4 class="card-title">${contract.contract_number}</h4>
                        <div class="card-subtitle">${contract.contract_description || 'No description'}</div>
                        <div class="card-subtitle">Manufacturer: <strong>${contract.manufacturer_name || 'Unknown'}</strong></div>
                    </div>
                    <div class="status-indicator">
                        <span class="status-text ${isExcluded ? 'status-excluded' : 'status-included'}">
                            ${isExcluded ? 'Excluded' : 'Included'}
                        </span>
                        <button type="button" class="toggle-action-btn" data-contract="${contract.contract_number}">
                            ${isExcluded ? 'Include' : 'Exclude'}
                        </button>
                    </div>
                </div>
                <div class="card-stats">
                    <div class="card-stat">
                        <div class="stat-value">${contract.total_matches}</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="card-stat">
                        <div class="stat-value">${contract.exact_matches}</div>
                        <div class="stat-label">Exact MFN Matches</div>
                    </div>
                </div>
            `;
            
            contractCardsContainer.appendChild(card);
        });
        
        // Add click event to card for details view
        document.querySelectorAll('.contract-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Ignore clicks on the toggle button
                if (e.target.classList.contains('toggle-action-btn') || 
                    e.target.closest('.toggle-action-btn')) {
                    return;
                }
                
                // Show contract details
                showContractDetails(this.dataset.contractNumber);
            });
        });
        
        // Add click event to toggle buttons - fixed to use proper selector
        document.querySelectorAll('.toggle-action-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent opening the modal
                
                const contractNum = this.dataset.contract;
                const isExcluded = excludedContracts.includes(contractNum);
                
                // Toggle inclusion state
                toggleContractInclusion(contractNum, isExcluded);
            });
        });
    }

    // Add this new function to update the tags display
    function updateIncludedContractsTags() {
        const tagsContainer = document.getElementById('included-contracts-tags');
        if (!tagsContainer) return;
        
        tagsContainer.innerHTML = '';
        
        if (includedContracts.length === 0) {
            tagsContainer.innerHTML = '<span class="empty-tag">No contracts included</span>';
            return;
        }
        
        includedContracts.forEach(contractNum => {
            const tag = document.createElement('span');
            tag.className = 'contract-tag';
            tag.textContent = contractNum;
            tagsContainer.appendChild(tag);
        });
    }

    // Update the toggle function to refresh the tags
    function toggleContractInclusion(contractNum, currentlyExcluded) {
        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        
        // Send request to update inclusion status
        fetch('/include-exclude-contract', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_num: contractNum,
                include: currentlyExcluded // If currently excluded, we want to include it
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // Update local arrays
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
                
                // Update the UI
                const card = document.querySelector(`.contract-card[data-contract-number="${contractNum}"]`);
                if (card) {
                    const isExcluded = excludedContracts.includes(contractNum);
                    
                    // Update card class
                    card.className = `contract-card ${isExcluded ? 'excluded' : 'selected'}`;
                    
                    // Update status text
                    const statusText = card.querySelector('.status-text');
                    statusText.className = `status-text ${isExcluded ? 'status-excluded' : 'status-included'}`;
                    statusText.textContent = isExcluded ? 'Excluded' : 'Included';
                    
                    // Update toggle button text
                    const toggleBtn = card.querySelector('.toggle-action-btn');
                    toggleBtn.textContent = isExcluded ? 'Include' : 'Exclude';
                }
                
                // Update included contracts tags
                updateIncludedContractsTags();
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error toggling contract inclusion:', error);
        });
    }

    
    // Filter contracts when searching
    contractSearch.addEventListener('input', function() {
        filterContracts();
    });

    // Also filter when search type changes
    searchTypeSelect.addEventListener('change', function() {
        filterContracts();
    });

    function filterContracts() {
        const searchTerm = contractSearch.value.toLowerCase();
        const searchType = searchTypeSelect.value;
        
        if (!allContracts.length) return;
        
        // Filter contracts by search term and type
        const filteredContracts = allContracts.filter(contract => {
            // Check if contract info contains search term
            const contractInfo = [
                contract.contract_number,
                contract.contract_description || '',
                contract.manufacturer_name || ''
            ].join(' ').toLowerCase();
            
            // Apply filter based on search type
            if (searchType === 'contains') {
                return contractInfo.includes(searchTerm);
            } else {
                // 'not-contains'
                return !contractInfo.includes(searchTerm);
            }
        });
        
        displayContracts(filteredContracts);
    }
    
    function toggleContractInclusion(contractNum, currentlyExcluded) {
        // Show loading
        loadingOverlay.style.display = 'flex';
        
        fetch('/include-exclude-contract', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contract_num: contractNum,
                include: currentlyExcluded // If currently excluded, include it now
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // Update local tracking
                includedContracts = data.included_contracts;
                excludedContracts = data.excluded_contracts;
                
                // Refresh display
                displayContracts(allContracts);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            alert('Error: ' + error);
        });
    }
    
    function showContractDetails(contractNum) {
        // Show loading
        loadingOverlay.style.display = 'flex';
        
        fetch(`/get-duplicate-items/${contractNum}`)
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                const contract = data.contract;
                
                // Populate modal with contract info
                document.getElementById('modal-contract-number').textContent = contract.contract_number;
                document.getElementById('modal-contract-description').textContent = contract.contract_description || 'N/A';
                document.getElementById('modal-contract-owner').textContent = contract.contract_owner || 'N/A';
                
                // Populate items table
                const itemsTable = document.getElementById('items-table').querySelector('tbody');
                itemsTable.innerHTML = '';
                
                contract.items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Is exact match
                    const isExactMatch = item.same_mfg_part_num === 1;
                    
                    row.innerHTML = `
                        <td>${item.mfg_part_num_ccx || 'N/A'}</td>
                        <td>${item.Mfg_Part_Num || 'N/A'}</td>
                        <td>
                            <span class="match-indicator ${isExactMatch ? 'match' : 'mismatch'}">
                                ${isExactMatch ? 'Exact Match' : 'Partial Match'}
                            </span>
                        </td>
                        <td>${item.uom_ccx || 'N/A'}</td>
                        <td>${item.UOM || 'N/A'}</td>
                        <td>$${parseFloat(item.price_ccx).toFixed(2) || 'N/A'}</td>
                        <td>$${parseFloat(item.Contract_Price).toFixed(2) || 'N/A'}</td>
                        <td>${item.description_ccx || 'N/A'}</td>
                        <td>${item.Description || 'N/A'}</td>
                    `;
                    
                    itemsTable.appendChild(row);
                });
                
                // Show modal
                modal.style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            alert('Error: ' + error);
        });
    }
    
    // Close modal when clicking on X button
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Continue to item-level review
    continueBtn.addEventListener('click', function() {
        if (includedContracts.length === 0) {
            alert('Please include at least one contract before proceeding.');
            return;
        }
        
        // In a real implementation, we'd submit to the server
        // For now, just simulate a POST request to process-step
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/process-step/2';
        document.body.appendChild(form);
        form.submit();
    });
});
</script>
